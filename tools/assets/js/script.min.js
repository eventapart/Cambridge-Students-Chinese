let appContainer=document.getElementById("app"),$=(appContainer.classList.add("loading-state"),e=>document.getElementById(e));function shuffleArrayInPlace(t){for(let e=t.length-1;0<e;e--){var i=Math.floor(Math.random()*(e+1));[t[e],t[i]]=[t[i],t[e]]}return t}function escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function highlightText(e,t){return t&&e?e.replace(new RegExp(`(${escapeRegExp(t)})`,"gi"),"<mark>$1</mark>"):e||""}function debounce(t,i){let r;return(...e)=>{clearTimeout(r),r=setTimeout(()=>t.apply(this,e),i)}}function renderStatusMessage(e,t,i="muted"){e.innerHTML=`<p></p><p class="text-${i} text-center">${t}</p><p></p>`}let igcseData=[],allIdioms=[],idiomMap=new Map,idiomsParts=[],invertedIndex=new Map;async function loadAllIdioms(e=10){appContainer.classList.add("loading-state");var i=[];for(let t=1;t<=e;t++)i.push(fetch(`./dictionaries/idioms_part${t}.min.json`).then(e=>e.ok?e.json():Promise.reject("HTTP "+e.status)).then(e=>{e.forEach(t=>{t.idiom=t.idiom||"",t.definition=t.definition||"",t.idiomLower=t.idiom.toLowerCase(),t.definitionLower=t.definition.toLowerCase(),(t.idiomLower+" "+t.definitionLower).split(/\s+/).forEach(e=>{invertedIndex.has(e)||invertedIndex.set(e,new Set),invertedIndex.get(e).add(t)})}),allIdioms.push(...e),(idiomsParts[t-1]=e).forEach(e=>idiomMap.set(e.idiom,e))}));await Promise.all(i),appContainer.classList.remove("loading-state"),renderHomeIdioms(),renderIgcseIdioms(),renderRandomIdiomStories(),initTabListeners()}function buildIdiomCardContent(e){var t=(e,t)=>t?`<strong style="margin-left:-2.75rem">${e}</strong> `+t:"";return[t("释义",e.definition),t("用法",e.usage),t("出处",(e.source?.text||"")+(e.source?.book?`（${e.source.book}）`:"")),t("例句",(e.example?.text||"")+(e.example?.book?`（${e.example.book}）`:"")),t("官方",e.exampleSentence),e.similar?.length?t("近义",e.similar.join("、")):"",e.opposite?.length?t("反义",e.opposite.join("、")):""].filter(Boolean).join("<br />")}class VirtualList{constructor(e,t,i={}){this.container=e,this.items=t,this.rowHeight=i.rowHeight||150,this.buffer=i.buffer||3,this.keyword=i.highlight||"",this.scrollContainer=document.createElement("div"),this.scrollContainer.style.position="relative",this.scrollContainer.style.height=t.length*this.rowHeight+"px",this.container.innerHTML="",this.container.appendChild(this.scrollContainer),this.visibleStart=0,this.visibleEnd=0,this.handleScroll=this.handleScroll.bind(this),this.container.addEventListener("scroll",this.handleScroll),this.render()}render(){var e=this.container.scrollTop,t=this.container.clientHeight,i=Math.max(Math.floor(e/this.rowHeight)-this.buffer,0),r=Math.min(Math.ceil((e+t)/this.rowHeight)+this.buffer,this.items.length);if(i!==this.visibleStart||r!==this.visibleEnd){this.visibleStart=i,this.visibleEnd=r,this.scrollContainer.innerHTML="";for(let e=i;e<r;e++){var s=this.items[e],n=this.keyword?highlightText(s.idiom,this.keyword):s.idiom,o=this.keyword?highlightText(s.definition,this.keyword):s.definition,a=document.createElement("div");a.style.position="absolute",a.style.top=e*this.rowHeight+"px",a.style.width="100%",a.style.height=this.rowHeight+"px",a.className="col",a.innerHTML=`
        <div class="card shadow-sm h-100">
          <div class="card-body d-flex flex-column card-chinese">
            <h5 class="card-title mb-4">${n}<br><small class="text-muted">${s.pinyin||""}</small></h5>
            <p class="card-text mt-auto" style="padding-left:2.75rem">${buildIdiomCardContent({...s,idiom:n,definition:o})}</p>
          </div>
        </div>`,this.scrollContainer.appendChild(a)}}}handleScroll(){this.render()}update(e,t=""){this.items=e,this.keyword=t,this.scrollContainer.style.height=e.length*this.rowHeight+"px",this.container.scrollTop=0,this.render()}destroy(){this.container.removeEventListener("scroll",this.handleScroll),this.container.innerHTML=""}}let searchVirtualList=null;async function searchIdioms(e){if(!e)return[];e=e.toLowerCase().split(/\s+/);let t=[];return e.forEach(e=>{invertedIndex.has(e)&&t.push(Array.from(invertedIndex.get(e)))}),t.length?t.reduce((e,t)=>e.filter(e=>t.includes(e))):[]}async function handleIdiomSearch(){var e=$("search-input").value.trim().toLowerCase(),t=$("search-results"),i=$("button-addon2");if(searchVirtualList&&searchVirtualList.destroy(),e.length<2)renderStatusMessage(t,"请输入至少2个字符"),e||renderRandomIdiomStories(),i.disabled=!0;else{i.disabled=!1;i=await searchIdioms(e);if(!i.length)return renderStatusMessage(t,"未找到相关成语");searchVirtualList=new VirtualList(t,i,{rowHeight:180,buffer:5,highlight:e})}}let homeVirtualList=null,igcseVirtualList=null,randomStoryVirtualList=null;function renderHomeIdioms(){var e=$("home-idioms");if(!allIdioms.length)return renderStatusMessage(e,"成语数据加载中...");homeVirtualList&&homeVirtualList.destroy(),homeVirtualList=new VirtualList(e,shuffleArrayInPlace([...allIdioms]),{rowHeight:180,buffer:5})}function renderIgcseIdioms(){var e=$("igcse-idioms");if(!igcseData.length)return renderStatusMessage(e,"IGCSE数据加载中...");igcseVirtualList&&igcseVirtualList.destroy(),igcseVirtualList=new VirtualList(e,igcseData,{rowHeight:180,buffer:5})}function renderRandomIdiomStories(){var e=$("random-idioms"),t=allIdioms.filter(e=>e.story?.length);if(!t.length)return renderStatusMessage(e,"暂无成语故事");randomStoryVirtualList&&randomStoryVirtualList.destroy(),randomStoryVirtualList=new VirtualList(e,shuffleArrayInPlace(t),{rowHeight:180,buffer:5})}document.addEventListener("DOMContentLoaded",()=>{loadIgcseData(),loadAllIdioms(10),$("search-input").addEventListener("input",debounce(handleIdiomSearch,150)),$("button-addon2").disabled=!0,$("best-score").textContent=bestScore});