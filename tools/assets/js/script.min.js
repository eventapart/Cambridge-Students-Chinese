let appContainer=document.getElementById("app"),$=(appContainer.classList.add("loading-state"),e=>document.getElementById(e));function shuffleArrayInPlace(t){for(let e=t.length-1;0<e;e--){var i=Math.floor(Math.random()*(e+1));[t[e],t[i]]=[t[i],t[e]]}return t}function escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function highlightText(e,t){return t&&e?e.replace(new RegExp(`(${escapeRegExp(t)})`,"gi"),"<mark>$1</mark>"):e||""}function debounce(t,i){let s;return(...e)=>{clearTimeout(s),s=setTimeout(()=>t.apply(this,e),i)}}function renderStatusMessage(e,t,i="muted"){e.innerHTML=`<p></p><p class="text-${i} text-center">${t}</p><p></p>`}let igcseData=[],allIdioms=[],idiomMap=new Map,idiomsParts=[],invertedIndex=new Map;async function loadAllIdioms(e=10){appContainer.classList.add("loading-state");var i=[];for(let t=1;t<=e;t++)i.push(fetch(`./dictionaries/idioms_part${t}.min.json`).then(e=>e.ok?e.json():Promise.reject("HTTP "+e.status)).then(e=>{e.forEach(t=>{t.idiom=t.idiom||"",t.definition=t.definition||"",t.idiomLower=t.idiom.toLowerCase(),t.definitionLower=t.definition.toLowerCase(),(t.idiomLower+" "+t.definitionLower).split(/\s+/).forEach(e=>{invertedIndex.has(e)||invertedIndex.set(e,new Set),invertedIndex.get(e).add(t)})}),allIdioms.push(...e),(idiomsParts[t-1]=e).forEach(e=>idiomMap.set(e.idiom,e))}));await Promise.all(i),appContainer.classList.remove("loading-state"),renderHomeIdioms(),renderIgcseIdioms(),renderRandomIdiomStories(),initTabListeners()}function buildIdiomCardContent(e){var t=(e,t)=>t?`<strong style="margin-left:-2.75rem">${e}</strong> `+t:"";return[t("释义",e.definition),t("用法",e.usage),t("出处",(e.source?.text||"")+(e.source?.book?`（${e.source.book}）`:"")),t("例句",(e.example?.text||"")+(e.example?.book?`（${e.example.book}）`:"")),t("官方",e.exampleSentence),e.similar?.length?t("近义",e.similar.join("、")):"",e.opposite?.length?t("反义",e.opposite.join("、")):""].filter(Boolean).join("<br />")}class VirtualList{constructor(e,t,i=150,s=3){this.container=e,this.items=t,this.rowHeight=i,this.buffer=s,this.scrollContainer=document.createElement("div"),this.scrollContainer.style.position="relative",this.scrollContainer.style.height=t.length*i+"px",this.container.innerHTML="",this.container.appendChild(this.scrollContainer),this.visibleStart=0,this.visibleEnd=0,this.handleScroll=this.handleScroll.bind(this),this.container.addEventListener("scroll",this.handleScroll),this.render()}render(){var e=this.container.scrollTop,t=this.container.clientHeight,i=Math.max(Math.floor(e/this.rowHeight)-this.buffer,0),s=Math.min(Math.ceil((e+t)/this.rowHeight)+this.buffer,this.items.length);if(i!==this.visibleStart||s!==this.visibleEnd){this.visibleStart=i,this.visibleEnd=s,this.scrollContainer.innerHTML="";for(let e=i;e<s;e++){var r=this.items[e],n=document.createElement("div");n.style.position="absolute",n.style.top=e*this.rowHeight+"px",n.style.width="100%",n.style.height=this.rowHeight+"px",n.className="col",n.innerHTML=`
        <div class="card shadow-sm h-100">
          <div class="card-body d-flex flex-column card-chinese">
            <h5 class="card-title mb-4">${r.idiom}<br><small class="text-muted">${r.pinyin||""}</small></h5>
            <p class="card-text mt-auto" style="padding-left:2.75rem">${buildIdiomCardContent(r)}</p>
          </div>
        </div>`,this.scrollContainer.appendChild(n)}}}handleScroll(){this.render()}destroy(){this.container.removeEventListener("scroll",this.handleScroll),this.container.innerHTML=""}}let searchVirtualList=null;async function searchIdioms(e){if(!e)return[];e=e.toLowerCase().split(/\s+/);let t=[];return e.forEach(e=>{invertedIndex.has(e)&&t.push(Array.from(invertedIndex.get(e)))}),t.length?t.reduce((e,t)=>e.filter(e=>t.includes(e))):[]}async function handleIdiomSearch(){let t=$("search-input").value.trim().toLowerCase();var e=$("search-results"),i=$("button-addon2");if(searchVirtualList&&(searchVirtualList.destroy(),searchVirtualList=null),t.length<2)renderStatusMessage(e,"请输入至少2个字符"),t||renderRandomIdiomStories(),i.disabled=!0;else{i.disabled=!1;i=await searchIdioms(t);if(!i.length)return renderStatusMessage(e,"未找到相关成语");i=i.map(e=>({...e,idiom:highlightText(e.idiom,t),definition:highlightText(e.definition,t)}));searchVirtualList=new VirtualList(e,i,180,5)}}let homeVirtualList=null,igcseVirtualList=null,randomStoryVirtualList=null;function renderHomeIdioms(){var e=$("home-idioms");if(!allIdioms.length)return renderStatusMessage(e,"成语数据加载中...");homeVirtualList&&homeVirtualList.destroy(),homeVirtualList=new VirtualList(e,shuffleArrayInPlace([...allIdioms]),180,5)}function renderIgcseIdioms(){var e=$("igcse-idioms");if(!igcseData.length)return renderStatusMessage(e,"IGCSE数据加载中...");igcseVirtualList&&igcseVirtualList.destroy(),igcseVirtualList=new VirtualList(e,igcseData,180,5)}function renderRandomIdiomStories(){var e=$("random-idioms"),t=allIdioms.filter(e=>e.story?.length);if(!t.length)return renderStatusMessage(e,"暂无成语故事");randomStoryVirtualList&&randomStoryVirtualList.destroy(),randomStoryVirtualList=new VirtualList(e,shuffleArrayInPlace(t),180,5)}document.addEventListener("DOMContentLoaded",()=>{loadIgcseData(),loadAllIdioms(10),$("search-input").addEventListener("input",debounce(handleIdiomSearch,150)),$("button-addon2").disabled=!0,$("best-score").textContent=bestScore});