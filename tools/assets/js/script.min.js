let appContainer=document.getElementById("app"),$=(appContainer.classList.add("loading-state"),e=>document.getElementById(e));function shuffleArrayInPlace(t){for(let e=t.length-1;0<e;e--){var i=Math.floor(Math.random()*(e+1));[t[e],t[i]]=[t[i],t[e]]}return t}function escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function highlightText(e,t){return t&&e?e.replace(new RegExp(`(${escapeRegExp(t)})`,"gi"),"<mark>$1</mark>"):e||""}function debounce(t,i){let n;return function(...e){clearTimeout(n),n=setTimeout(()=>t.apply(this,e),i)}}function renderStatusMessage(e,t,i="muted"){e.innerHTML=`<p></p><p class="text-${i} text-center">${t}</p><p></p>`}class Paginator{constructor(e,t,i,n=5){this.container=$(e),this.totalPages=t,this.onPageChange=i,this.maxButtons=n,this.currentPage=1,this.handleKey=this.handleKey.bind(this),document.addEventListener("keydown",this.handleKey)}render(e=1){if(this.currentPage=e,this.container){var a,{totalPages:r,maxButtons:o,currentPage:s}=this;let t="";1<s&&(t+=`<li class="page-item"><a class="page-link" data-page="${s-1}" href="#">上一页</a></li>`);let i,n;r<=o?[i,n]=[1,r]:(a=Math.floor(o/2),[i,n]=s<=a?[1,o]:r<=s+a?[r-o+1,r]:[s-a,s+a]);for(let e=i;e<=n;e++){var l=e===s?"active":"";t+=`<li class="page-item ${l}"><a class="page-link" data-page="${e}" href="#">${e}</a></li>`}s<r&&(t+=`<li class="page-item"><a class="page-link" data-page="${s+1}" href="#">下一页</a></li>`),this.container.innerHTML=t,this.bindEvents(),this.onPageChange(e)}}bindEvents(){this.container.onclick=e=>{var t=e.target.closest("a[data-page]");t&&(e.preventDefault(),e=parseInt(t.dataset.page,10))&&e!==this.currentPage&&this.render(e)}}handleKey(e){var t;this.container.offsetParent&&this.container.querySelector("[data-page]")&&(t=document.querySelector("#myTabs .nav-link.active")?.getAttribute("href"))&&this.container.closest(t)&&("ArrowLeft"===e.key&&1<this.currentPage?this.render(this.currentPage-1):"ArrowRight"===e.key&&this.currentPage<this.totalPages&&this.render(this.currentPage+1))}destroy(){document.removeEventListener("keydown",this.handleKey),this.container&&(this.container.innerHTML="")}}let igcseData=null,allIdioms=[],idiomMap=new Map,idiomsParts=[],idiomsEnMap=new Map;async function loadIgcseData(){try{var e=await fetch("./dictionaries/idioms_cam_masked.min.json");if(!e.ok)throw new Error("HTTP "+e.status);igcseData=await e.json(),console.log("IGCSE 数据加载成功")}catch(e){console.error("加载 IGCSE 数据失败:",e),alert("无法加载数据，请稍后重试")}}async function loadIdiomsEnMap(){try{var e=await fetch("./dictionaries/idioms_en_map.min.json");if(!e.ok)throw new Error("HTTP "+e.status);(await e.json()).forEach(e=>{var t=(e.idiom||"").trim();t&&idiomsEnMap.set(t,e)}),console.log("idioms_en_map 加载完成，条目数：",idiomsEnMap.size)}catch(e){console.warn("加载 idioms_en_map.min.json 失败或不存在：",e)}}async function loadAllIdioms(e=10){appContainer.classList.add("loading-state");var i=[];for(let t=1;t<=e;t++)i.push(fetch(`./dictionaries/idioms_part${t}.min.json`).then(e=>e.json()).then(e=>{e.forEach(e=>{e.idiom=e.idiom||"",e.definition=e.definition||"",e.usage=e.usage||"",e.source=e.source||{},e.example=e.example||{},e.pinyin=e.pinyin||"",e.similar=e.similar||[],e.opposite=e.opposite||[],e.story=e.story||[],e.idiomLower=e.idiom.toLowerCase(),e.definitionLower=e.definition.toLowerCase(),e.litLower=(e.lit||"").toLowerCase(),e.figLower=(e.fig||"").toLowerCase()}),allIdioms.push(...e),(idiomsParts[t-1]=e).forEach(e=>idiomMap.set(e.idiom,e)),console.log(`Part ${t} 加载完成`)}).catch(e=>console.error(`加载 idioms_part${t}.json 失败:`,e)));i.push(loadIdiomsEnMap()),await Promise.all(i),idiomsEnMap.forEach((e,t)=>{t=idiomMap.get(t);t&&(e.tongyi&&(t.lit=e.tongyi.lit||t.lit,t.fig=e.tongyi.fig||t.fig),e.petci&&(t.petci=e.petci),t._enmap=e,t.litLower=(t.lit||"").toLowerCase(),t.figLower=(t.fig||"").toLowerCase())}),appContainer.classList.remove("loading-state"),renderHomeIdioms(),renderIgcseIdioms(),renderRandomIdiomStories(),initTabListeners()}function buildIdiomCardContent(e){var t=(e,t)=>t?`<strong style="margin-left:-2.75rem">${e}</strong> `+t:"",i=[t("释义",e.definition),t("用法",e.usage),t("出处",(e.source?.text||"")+(e.source?.book?`（${e.source.book}）`:"")),t("例句",(e.example?.text||"")+(e.example?.book?`（${e.example.book}）`:"")),t("官方",e.exampleSentence),e.similar?.length?t("近义",e.similar.join("、")):"",e.opposite?.length?t("反义",e.opposite.join("、")):""].filter(Boolean),n=[];return e.lit&&n.push(t("Tongyi Lit.",e.lit)),e.fig&&n.push(t("TONGYI Fig.",e.fig)),e.petci&&n.push(t("Cornell PETCI",e.petci)),(i.length&&i[0].includes("释义")?[i[0],...n,...i.slice(1)]:[...n,...i]).filter(Boolean).join("<br />")}function renderIdiomCards(e,t){e.innerHTML=t.map(e=>`
    <div class="col">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex flex-column card-chinese">
          <h5 class="card-title mb-4">${e.idiom}<br><small class="text-muted">${e.pinyin||""}</small></h5>
          <p class="card-text mt-auto" style="padding-left:2.75rem">${buildIdiomCardContent(e)}</p>
        </div>
      </div>
    </div>`).join("")}function renderHomeIdioms(){var e=$("random-idioms");allIdioms.length&&renderIdiomCards(e,shuffleArrayInPlace([...allIdioms]).slice(0,3))}function renderRandomIdiomStories(){var e=$("search-results"),t=allIdioms.filter(e=>e.story?.length);if(!t.length)return renderStatusMessage(e,"暂无成语故事");renderIdiomCards(e,shuffleArrayInPlace(t).slice(0,3).map(e=>({...e,definition:'<strong style="margin-left:-2.75rem">故事</strong> '+e.story.join("<br /><br />")})))}let searchPaginator=null;async function searchIdioms(t){return t?(await Promise.all(idiomsParts.map(e=>e.filter(e=>e.idiomLower.includes(t)||e.definitionLower.includes(t)||e.litLower?.includes(t)||e.figLower?.includes(t))))).flat():[]}async function handleIdiomSearch(){let i=$("search-input").value.trim();var e=i.toLowerCase();let n=$("search-results");var a=$("pagination-controls-dict"),r=$("button-addon2");if(n.innerHTML="",a&&(a.innerHTML=""),searchPaginator&&(searchPaginator.destroy(),searchPaginator=null),e.length<2)renderStatusMessage(n,"请输入至少2个字符"),e||renderRandomIdiomStories(),r.disabled=!0;else{r.disabled=!1;let t=await searchIdioms(e);if(!t.length)return renderStatusMessage(n,"未找到相关成语");a=Math.ceil(t.length/3);(searchPaginator=new Paginator("pagination-controls-dict",a,e=>{e=t.slice(3*(e-1),3*e).map(e=>({...e,idiom:highlightText(e.idiom,i),definition:highlightText(e.definition||"",i),lit:highlightText(e.lit||"",i),fig:highlightText(e.fig||"",i)}));renderIdiomCards(n,e)})).render(1)}}function renderIgcseIdioms(e=1){let t=$("igcse-idioms");var i,n,a="pagination-controls-igcse",r=(t.innerHTML="",$(a).innerHTML="",Object.entries(igcseData||{}).sort((e,t)=>t[0].localeCompare(e[0],"en",{numeric:!0})));let o=[];for([i,n]of r)for(var[s,l]of Object.entries(n)){s=idiomMap.get(s);s&&o.push({...s,exampleSentence:`${l} (${i})`})}if(!o.length)return t.innerHTML="<p>暂无真题成语数据</p>";r=Math.ceil(o.length/3);new Paginator(a,r,e=>renderIdiomCards(t,o.slice(3*(e-1),3*e))).render(e)}let currentQuestion=null,currentScore=0,bestScore=parseInt(localStorage.getItem("idiomGameBestScore"))||0;function renderNextGameQuestion(){var e=allIdioms[Math.floor(Math.random()*allIdioms.length)],t=shuffleArrayInPlace([...allIdioms]).slice(0,3).map(e=>e.idiom),i=(t.includes(e.idiom)||(t[Math.floor(3*Math.random())]=e.idiom),t.indexOf(e.idiom));currentQuestion={definition:e.definition,correctIndex:i},$("question").innerHTML=`<strong style="border-bottom:var(--text-color) 1px dashed">“${e.definition}” 对应的成语是？</strong>`,$("options").innerHTML=t.map((e,t)=>`
      <div class="col">
        <button class="btn btn-outline-dark option card h-100" onclick="handleGameAnswer(${t})">
          <span class="card-body d-flex flex-column text-center card-chinese" style="justify-content:center; line-height:1.2">
            <span class="card-title mb-0">${e}<br /><small class="text-muted">${idiomMap.get(e)?.pinyin||""}</small></span>
          </span>
        </button>
      </div>`).join("")}function handleGameAnswer(e){var t,i,n;currentQuestion&&(t=$("check-toast"),i=$("toast-body"),n=bootstrap.Toast.getOrCreateInstance(t),e===currentQuestion.correctIndex?(currentScore+=10,($("current-score").textContent=currentScore)>bestScore&&(bestScore=currentScore,$("best-score").textContent=bestScore,localStorage.setItem("idiomGameBestScore",bestScore)),t.classList.replace("bg-danger","bg-success"),i.innerHTML="正确！+10 分",setTimeout(renderNextGameQuestion,300)):(t.classList.replace("bg-success","bg-danger"),i.innerHTML="错误"),n.show())}function restartGame(){currentScore=0,$("current-score").textContent=currentScore,renderNextGameQuestion()}function initTabListeners(){document.querySelector('#myTabs a[href="#game"]')?.addEventListener("shown.bs.tab",renderNextGameQuestion),document.querySelector('#myTabs a[href="#dictionary"]')?.addEventListener("shown.bs.tab",()=>{searchPaginator&&(searchPaginator.destroy(),searchPaginator=null),$("search-input").value="",renderRandomIdiomStories()}),document.querySelector('#myTabs a[href="#igcse"]')?.addEventListener("shown.bs.tab",()=>renderIgcseIdioms(1)),document.querySelector('#myTabs a[href="#home"]')?.addEventListener("shown.bs.tab",renderRandomIdiomStories)}document.addEventListener("DOMContentLoaded",()=>{loadIgcseData(),loadAllIdioms(10),$("search-input").addEventListener("input",debounce(handleIdiomSearch,200)),$("button-addon2").disabled=!0,$("best-score").textContent=bestScore});