let appContainer=document.getElementById("app");appContainer.classList.add("loading-state");class Paginator{constructor(e,t,n,r=5){this.containerId=e,this.totalPages=t,this.onPageChange=n,this.maxButtons=r,this.currentPage=1}render(e=1){this.currentPage=e;e=document.getElementById(this.containerId);if(e){let t="";1<this.currentPage&&(t+=`<li class="page-item"><a class="page-link" data-page="${this.currentPage-1}" href="###">ä¸Šä¸€é¡µ</a></li>`);let n,r;var a,{totalPages:i,maxButtons:o,currentPage:s}=this;r=i<=o?(n=1,i):s<=(a=Math.floor(o/2))?(n=1,o):i<=s+a?(n=i-o+1,i):(n=s-a,s+a);for(let e=n;e<=r;e++){var l=e===this.currentPage?"active":"";t+=`<li class="page-item ${l}"><a class="page-link" data-page="${e}" href="###">${e}</a></li>`}this.currentPage<this.totalPages&&(t+=`<li class="page-item"><a class="page-link" data-page="${this.currentPage+1}" href="###">ä¸‹ä¸€é¡µ</a></li>`),e.innerHTML=t,this.bindEvents(e)}}bindEvents(e){var t=e.cloneNode(!0);e.replaceWith(t),t.addEventListener("click",e=>{e.preventDefault(),"A"===e.target.tagName&&(e=parseInt(e.target.dataset.page),!isNaN(e))&&1<=e&&e<=this.totalPages&&e!==this.currentPage&&(this.render(e),this.onPageChange(e))})}goTo(e){1<=e&&e<=this.totalPages&&e!==this.currentPage&&(this.render(e),this.onPageChange(e))}}let igcseData=null;async function loadIgcseData(){try{var e=await fetch("./dictionaries/idioms_cam_masked.min.json");if(!e.ok)throw new Error("HTTP é”™è¯¯ï¼çŠ¶æ€ç : "+e.status);igcseData=await e.json(),console.log("æ•°æ®åŠ è½½æˆåŠŸ:",igcseData)}catch(e){console.error("åŠ è½½æ•°æ®å¤±è´¥:",e),alert("æ— æ³•åŠ è½½æ•°æ®ï¼Œè¯·ç¨åé‡è¯•ã€‚")}}document.addEventListener("DOMContentLoaded",()=>{loadIgcseData()});let allIdioms=[];function showHome(){let t=document.getElementById("random-idioms");allIdioms&&0!==allIdioms.length&&(t.innerHTML="",shuffle(allIdioms).slice(0,3).forEach(e=>{renderCard(t,e.idiom,e.pinyin,buildCardContent(e))}))}function shuffle(e){var t=[...e];for(let e=t.length-1;0<e;e--){var n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}return t}function buildCardContent(e){let t="";e.definition&&(t+=`<strong style="margin-left:-2.75rem">é‡Šä¹‰</strong> ${e.definition}<br />`),e.usage&&"string"==typeof e.usage&&(t+=`<strong style="margin-left:-2.75rem">ç”¨æ³•</strong> ${e.usage}<br />`);var n=e.source,r=((n?.text||n?.book)&&(r=n.text||"",n=n.book?`ï¼ˆ${n.book}ï¼‰`:"",t+=`<strong style="margin-left:-2.75rem">å‡ºå¤„</strong> ${r}${n}<br />`),e.example);return(r?.text||r?.book)&&(n=r.text||"",r=r.book?`ï¼ˆ${r.book}ï¼‰`:"",t+=`<strong style="margin-left:-2.75rem">ä¾‹å¥</strong> ${n}${r}<br />`),e.exampleSentence&&(t+=`<strong style="margin-left:-2.75rem">å®˜æ–¹</strong> ${e.exampleSentence}<br />`),Array.isArray(e.similar)&&0<e.similar.length&&(t+=`<strong style="margin-left:-2.75rem">è¿‘ä¹‰</strong> ${e.similar.join("ã€")}<br />`),Array.isArray(e.opposite)&&0<e.opposite.length&&(t+=`<strong style="margin-left:-2.75rem">åä¹‰</strong> ${e.opposite.join("ã€")}<br />`),t.replace(/<br\s*\/?>\s*$/,"")}function renderCard(e,t,n,r){var a=document.createElement("div");a.className="col",a.innerHTML=`
    <div class="card shadow-sm h-100">
      <div class="card-body d-flex flex-column card-chinese">
        <h5 class="card-title mb-4">${t}<br><small class="text-muted" style="font-family:Helvetica, Arial, sans-serif">${n}</small></h5>
        <p class="card-text mt-auto" style="padding-left:2.75rem">${r}</p>
      </div>
    </div>
  `,e.appendChild(a)}function highlightText(e,t){return t?(t=new RegExp(`(${escapeRegExp(t)})`,"gi"),e.replace(t,"<mark>$1</mark>")):e}function escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}fetch("./dictionaries/idioms.min.json").then(e=>e.json()).then(e=>{allIdioms=e,appContainer.classList.remove("loading-state"),showHome(),showIgcseIdioms(),showRandomStory(),document.querySelector('#myTabs a[href="#game"]').addEventListener("shown.bs.tab",()=>{nextQuestion()}),[document.querySelector('#myTabs a[href="#home"]'),document.querySelector('#myTabs a[href="#dictionary"]')].forEach(e=>{e?.addEventListener("shown.bs.tab",()=>{"#game"!==document.querySelector("#myTabs .nav-link.active").getAttribute("href")&&showRandomStory()})})}).catch(e=>{console.error("æ•°æ®åŠ è½½å¤±è´¥:",e),appContainer.classList.remove("loading-state"),document.getElementById("random-idioms").innerHTML='<p></p><p class="text-danger text-center">åŠ è½½å¤±è´¥</p><p></p>'});let searchInput=document.getElementById("search-input"),searchBtn=document.getElementById("button-addon2");function searchIdiom(){let r=document.getElementById("search-input").value.trim(),a=document.getElementById("search-results");var e=document.getElementById("pagination-controls-dict");if(a.innerHTML="",e&&(e.innerHTML=""),r.length<2)a.innerHTML='<p></p><p class="text-muted text-center">è¯·è¾“å…¥è‡³å°‘2ä¸ªå­—ç¬¦</p><p></p>';else{let n=allIdioms.filter(e=>e.idiom?.toLowerCase().includes(r.toLowerCase())||"string"==typeof e.definition&&e.definition.toLowerCase().includes(r.toLowerCase()));if(0===n.length)a.innerHTML='<p></p><p class="text-muted text-center">æœªæ‰¾åˆ°ç›¸å…³æˆè¯­ã€‚</p><p></p>';else{e=Math.ceil(n.length/3);let t=e=>{var e=3*(e-1),t=3+e,e=n.slice(e,t);a.innerHTML="",e.forEach(e=>{var t=highlightText(e.idiom,r),n=highlightText(e.definition,r),n=buildCardContent({...e,definition:n});renderCard(a,t,e.pinyin,n)})};e=new Paginator("pagination-controls-dict",e,e=>{t(e)});t(1),e.render(1)}}}function debounce(t,n){let r;return function(...e){clearTimeout(r),r=setTimeout(()=>t.apply(this,e),n)}}searchInput.addEventListener("input",function(){var e=this.value.trim();2<=e.length?searchBtn.disabled=!1:searchBtn.disabled=!0,document.getElementById("search-results");""===e&&showRandomStory()}),searchBtn.disabled=!0,searchInput.addEventListener("input",debounce(()=>{searchIdiom()},100)),document.addEventListener("DOMContentLoaded",()=>{document.getElementById("search-input").addEventListener("input",()=>{searchIdiom()})});let lastStoryIdiom="";function showRandomStory(){var e,t=allIdioms.filter(e=>Array.isArray(e.story)&&0<e.story.length);0===t.length?document.getElementById("search-results").innerHTML='<div class="alert alert-info">æš‚æ— æˆè¯­æ•…äº‹</div>':(1<t.length&&t.filter(e=>e.idiom!==lastStoryIdiom),t=t[Math.floor(Math.random()*t.length)],lastStoryIdiom=t.idiom,e=t.story.map(e=>`<p>${e}</p>`).join(""),document.getElementById("search-results").innerHTML=`
    <div class="card border-warning bg-light">
      <div class="card-body">
        <h5 class="card-title text-warning">
          ğŸ“– æˆè¯­æ•…äº‹ï¼š${t.idiom}
          <small class="text-muted">ï¼ˆ${t.pinyin}ï¼‰</small>
        </h5>
        <div class="story-content">
          ${e}
        </div>
      </div>
    </div>
  `)}let currentPage=1,pageSize=3;function showIgcseIdioms(e=1){let t=document.getElementById("igcse-idioms");var n,r,a="pagination-controls-igcse",i=(t.innerHTML="",document.getElementById(a)),i=(i&&(i.innerHTML=""),Object.entries(igcseData).sort((e,t)=>t[0].localeCompare(e[0],"en",{numeric:!0,sensitivity:"base"}))),o=[];for([n,r]of i)for(let[t,e]of Object.entries(r)){var s=allIdioms.find(e=>e.idiom===t);s&&o.push({idiom:s.idiom,pinyin:s.pinyin,definition:s.definition,source:s.source||null,usage:s.usage||"",example:s.example||{},exampleSentence:`${e} (${n})`,similar:s.similar||[],opposite:s.opposite||[]})}var l,i=Math.ceil(o.length/3),e=Math.max(1,Math.min(e,i));0===o.length?t.innerHTML="<p>æš‚æ— çœŸé¢˜æˆè¯­æ•°æ®ã€‚</p>":(o.slice(l=3*(e-1),3+l).forEach(e=>{renderCard(t,e.idiom,e.pinyin,buildCardContent(e))}),new Paginator(a,i,e=>{showIgcseIdioms(e)}).render(e))}function goToPage(e){var t=Object.entries(igcseData).reduce((e,[,t])=>e+Object.keys(t).length,0),t=Math.ceil(t/3);Number.isInteger(e)&&1<=e&&e<=t&&e!==currentPage&&(currentPage=e,showIgcseIdioms())}let currentQuestion=null;function nextQuestion(){var e=allIdioms[Math.floor(Math.random()*allIdioms.length)];let t=[e.idiom];for(;t.length<3;){var n=allIdioms[Math.floor(Math.random()*allIdioms.length)].idiom;t.includes(n)||t.push(n)}t=shuffle(t),currentQuestion={definition:e.definition,correctIndex:t.indexOf(e.idiom)},document.getElementById("question").innerHTML=`<strong style="border-bottom:#333 1px dashed">â€œ${e.definition}â€ å¯¹åº”çš„æˆè¯­æ˜¯ï¼Ÿ</strong>`,document.getElementById("options").innerHTML=t.map((t,e)=>{var n=allIdioms.find(e=>e.idiom===t),n=n?n.pinyin:"æœªçŸ¥æ‹¼éŸ³";return`
      <div class="col">
        <button class="btn btn-outline-dark option card h-100" onclick="checkAnswer(${e})">
          <span class="card-body d-flex flex-column text-center card-chinese" style="justify-content: center; line-height:1.2">
            <span class="card-title mb-0">${t}<br /><small class="text-muted">${n}</small></span>
          </span>
        </button>
      </div>
    `}).join("")}function checkAnswer(e){var t,n,r;currentQuestion&&(t=document.getElementById("check-toast"),n=document.getElementById("toast-body"),r=bootstrap.Toast.getInstance(t)||new bootstrap.Toast(t),e===currentQuestion.correctIndex?(currentScore+=10,(document.getElementById("current-score").textContent=currentScore)>bestScore&&(bestScore=currentScore,document.getElementById("best-score").textContent=bestScore,localStorage.setItem("idiomGameBestScore",bestScore)),t.classList.remove("bg-danger","text-white"),t.classList.add("bg-success","text-white"),n.innerHTML="æ­£ç¡®ï¼+10 åˆ†",setTimeout(()=>{nextQuestion()},300)):(t.classList.remove("bg-success","text-white"),t.classList.add("bg-danger","text-white"),n.innerHTML="é”™è¯¯ã€‚"),r.hide(),r.show())}function shuffle(e){return[...e].sort(()=>Math.random()-.5)}let currentScore=0,bestScore=parseInt(localStorage.getItem("idiomGameBestScore"))||0;function restartGame(){currentScore=0,document.getElementById("current-score").textContent=currentScore,nextQuestion()}document.addEventListener("DOMContentLoaded",()=>{var e=document.getElementById("best-score");e&&(e.textContent=bestScore)});