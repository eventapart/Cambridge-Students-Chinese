let appContainer=document.getElementById("app"),$=(appContainer.classList.add("loading-state"),e=>document.getElementById(e));function shuffleArrayInPlace(t){for(let e=t.length-1;0<e;e--){var a=Math.floor(Math.random()*(e+1));[t[e],t[a]]=[t[a],t[e]]}return t}function escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function highlightText(e,t){return t&&e?e.replace(new RegExp(`(${escapeRegExp(t)})`,"gi"),"<mark>$1</mark>"):e||""}function debounce(t,a){let n;return(...e)=>{clearTimeout(n),n=setTimeout(()=>t.apply(this,e),a)}}function renderStatusMessage(e,t,a="muted"){e.innerHTML=`<p></p><p class="text-${a} text-center">${t}</p><p></p>`}class Paginator{constructor(e,t,a,n=5){this.container=$(e),this.totalPages=t,this.onPageChange=a,this.maxButtons=n,this.currentPage=1,this.handleKey=this.handleKey.bind(this),document.addEventListener("keydown",this.handleKey)}render(e=1){if(this.currentPage=e,this.container){var i,{totalPages:r,maxButtons:s,currentPage:o}=this;let t="";1<o&&(t+=`<li class="page-item"><a class="page-link" data-page="${o-1}" href="#">上一页</a></li>`);let a,n;r<=s?[a,n]=[1,r]:(i=Math.floor(s/2),[a,n]=o<=i?[1,s]:r<=o+i?[r-s+1,r]:[o-i,o+i]);for(let e=a;e<=n;e++){var d=e===o?"active":"";t+=`<li class="page-item ${d}"><a class="page-link" data-page="${e}" href="#">${e}</a></li>`}o<r&&(t+=`<li class="page-item"><a class="page-link" data-page="${o+1}" href="#">下一页</a></li>`),this.container.innerHTML=t,this.bindEvents(),this.onPageChange(e)}}bindEvents(){this.container.onclick=e=>{var t=e.target.closest("a[data-page]");t&&(e.preventDefault(),e=parseInt(t.dataset.page,10))&&e!==this.currentPage&&this.render(e)}}handleKey(e){var t;this.container.offsetParent&&this.container.querySelector("[data-page]")&&(t=document.querySelector("#myTabs .nav-link.active")?.getAttribute("href"))&&this.container.closest(t)&&("ArrowLeft"===e.key&&1<this.currentPage?this.render(this.currentPage-1):"ArrowRight"===e.key&&this.currentPage<this.totalPages&&this.render(this.currentPage+1))}destroy(){document.removeEventListener("keydown",this.handleKey),this.container&&(this.container.innerHTML="")}}let igcseData=null,allIdioms=[],idiomMap=new Map,idiomsParts=[],invertedIndex=new Map;async function loadAllIdioms(e=10){appContainer.classList.add("loading-state");var a=[];for(let t=1;t<=e;t++)a.push(fetch(`./dictionaries/idioms_part${t}.min.json`).then(e=>e.ok?e.json():Promise.reject("HTTP "+e.status)).then(e=>{e.forEach(t=>{t.idiom=t.idiom||"",t.definition=t.definition||"",t.idiomLower=t.idiom.toLowerCase(),t.definitionLower=t.definition.toLowerCase(),(t.idiomLower+" "+t.definitionLower).split(/\s+/).forEach(e=>{invertedIndex.has(e)||invertedIndex.set(e,new Set),invertedIndex.get(e).add(t)})}),allIdioms.push(...e),(idiomsParts[t-1]=e).forEach(e=>idiomMap.set(e.idiom,e))}));await Promise.all(a),appContainer.classList.remove("loading-state"),renderHomeIdioms(),renderIgcseIdioms(),renderRandomIdiomStories(),initTabListeners()}function buildIdiomCardContent(e){var t=(e,t)=>t?`<strong style="margin-left:-2.75rem">${e}</strong> `+t:"";return[t("释义",e.definition),t("用法",e.usage),t("出处",(e.source?.text||"")+(e.source?.book?`（${e.source.book}）`:"")),t("例句",(e.example?.text||"")+(e.example?.book?`（${e.example.book}）`:"")),t("官方",e.exampleSentence),e.similar?.length?t("近义",e.similar.join("、")):"",e.opposite?.length?t("反义",e.opposite.join("、")):""].filter(Boolean).join("<br />")}function renderIdiomCards(e,t){let n=document.createDocumentFragment();t.forEach((e,t)=>{var a=document.createElement("div");a.className="col",a.innerHTML=`
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex flex-column card-chinese">
          <h5 class="card-title mb-4">${e.idiom}<br><small class="text-muted">${e.pinyin||""}</small></h5>
          <p class="card-text mt-auto" style="padding-left:2.75rem">${buildIdiomCardContent(e)}</p>
        </div>
      </div>`,n.appendChild(a)}),e.innerHTML="",e.appendChild(n)}let searchPaginator=null;async function searchIdioms(e){if(!e)return[];e=e.toLowerCase().split(/\s+/);let t=[];return e.forEach(e=>{invertedIndex.has(e)&&t.push(Array.from(invertedIndex.get(e)))}),t.length?t.reduce((e,t)=>e.filter(e=>t.includes(e))):[]}async function handleIdiomSearch(){let a=$("search-input").value.trim().toLowerCase(),n=$("search-results");var e=$("pagination-controls-dict"),i=$("button-addon2");if(n.innerHTML="",e&&(e.innerHTML=""),searchPaginator&&(searchPaginator.destroy(),searchPaginator=null),a.length<2)renderStatusMessage(n,"请输入至少2个字符"),a||renderRandomIdiomStories(),i.disabled=!0;else{i.disabled=!1;let t=await searchIdioms(a);if(!t.length)return renderStatusMessage(n,"未找到相关成语");e=Math.ceil(t.length/3);(searchPaginator=new Paginator("pagination-controls-dict",e,e=>{e=t.slice(3*(e-1),3*e).map(e=>({...e,idiom:highlightText(e.idiom,a),definition:highlightText(e.definition,a)}));renderIdiomCards(n,e)})).render(1)}}document.addEventListener("DOMContentLoaded",()=>{loadIgcseData(),loadAllIdioms(10),$("search-input").addEventListener("input",debounce(handleIdiomSearch,150)),$("button-addon2").disabled=!0,$("best-score").textContent=bestScore});