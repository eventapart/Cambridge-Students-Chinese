let appContainer=document.getElementById("app");function shuffle(e){var t=[...e];for(let e=t.length-1;0<e;e--){var n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}return t}function escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function highlightText(e,t){return t?(t=new RegExp(`(${escapeRegExp(t)})`,"gi"),e.replace(t,"<mark>$1</mark>")):e}function debounce(t,n){let o;return function(...e){clearTimeout(o),o=setTimeout(()=>t.apply(this,e),n)}}appContainer.classList.add("loading-state");class Paginator{constructor(e,t,n,o=5){this.containerId=e,this.totalPages=t,this.onPageChange=n,this.maxButtons=o,this.currentPage=1}render(e=1){this.currentPage=e;e=document.getElementById(this.containerId);if(e){let t="";var r,{totalPages:a,maxButtons:s,currentPage:i}=this;1<i&&(t+=`<li class="page-item"><a class="page-link" data-page="${i-1}" href="###">上一页</a></li>`);let n,o;o=a<=s?(n=1,a):i<=(r=Math.floor(s/2))?(n=1,s):a<=i+r?(n=a-s+1,a):(n=i-r,i+r);for(let e=n;e<=o;e++){var l=e===i?"active":"";t+=`<li class="page-item ${l}"><a class="page-link" data-page="${e}" href="###">${e}</a></li>`}i<a&&(t+=`<li class="page-item"><a class="page-link" data-page="${i+1}" href="###">下一页</a></li>`),e.innerHTML=t,this.bindEvents(e)}}bindEvents(e){var t=e.cloneNode(!0);e.replaceWith(t),t.addEventListener("click",e=>{e.preventDefault(),"A"===e.target.tagName&&(e=parseInt(e.target.dataset.page),!isNaN(e))&&1<=e&&e<=this.totalPages&&e!==this.currentPage&&(this.render(e),this.onPageChange(e))})}goTo(e){1<=e&&e<=this.totalPages&&e!==this.currentPage&&(this.render(e),this.onPageChange(e))}}let igcseData=null,allIdioms=[];async function loadIgcseData(){try{var e=await fetch("./dictionaries/idioms_cam_masked.min.json");if(!e.ok)throw new Error("HTTP 错误: "+e.status);igcseData=await e.json(),console.log("IGCSE 数据加载成功")}catch(e){console.error("加载 IGCSE 数据失败:",e),alert("无法加载数据，请稍后重试。")}}function loadAllIdioms(){return fetch("./dictionaries/idioms.min.json").then(e=>e.json()).then(e=>{allIdioms=e,appContainer.classList.remove("loading-state"),showHome(),showIgcseIdioms(),showRandomStory(),setupTabListeners()}).catch(e=>{console.error("数据加载失败:",e),appContainer.classList.remove("loading-state"),document.getElementById("random-idioms").innerHTML='<p></p><p class="text-danger text-center">加载失败</p><p></p>'})}function renderCard(e,t,n,o){var r=document.createElement("div");r.className="col",r.innerHTML=`
    <div class="card shadow-sm h-100">
      <div class="card-body d-flex flex-column card-chinese">
        <h5 class="card-title mb-4">${t}<br><small class="text-muted">${n}</small></h5>
        <p class="card-text mt-auto" style="padding-left:2.75rem">${o}</p>
      </div>
    </div>
  `,e.appendChild(r)}function buildCardContent(e){var t=[];return e.definition&&t.push('<strong style="margin-left:-2.75rem">释义</strong> '+e.definition),e.usage&&t.push('<strong style="margin-left:-2.75rem">用法</strong> '+e.usage),(e.source?.text||e.source?.book)&&t.push('<strong style="margin-left:-2.75rem">出处</strong> '+(e.source.text||"")+(e.source.book?`（${e.source.book}）`:"")),(e.example?.text||e.example?.book)&&t.push('<strong style="margin-left:-2.75rem">例句</strong> '+(e.example.text||"")+(e.example.book?`（${e.example.book}）`:"")),e.exampleSentence&&t.push('<strong style="margin-left:-2.75rem">官方</strong> '+e.exampleSentence),e.similar?.length&&t.push('<strong style="margin-left:-2.75rem">近义</strong> '+e.similar.join("、")),e.opposite?.length&&t.push('<strong style="margin-left:-2.75rem">反义</strong> '+e.opposite.join("、")),t.join("<br />")}function showHome(){let t=document.getElementById("random-idioms");allIdioms.length&&(t.innerHTML="",shuffle(allIdioms).slice(0,3).forEach(e=>{renderCard(t,e.idiom,e.pinyin,buildCardContent(e))}))}function showRandomStory(){let t=document.getElementById("search-results");t.innerHTML="";var e=allIdioms.filter(e=>e.story?.length);e.length?shuffle(e).slice(0,3).forEach(e=>{renderCard(t,e.idiom,e.pinyin,'<strong style="margin-left:-2.75rem">故事</strong> '+e.story.join("<br /><br />"))}):t.innerHTML='<p></p><p class="text-muted text-center">暂无成语故事</p><p></p>'}function searchIdiom(){let n=document.getElementById("search-input").value.trim(),o=document.getElementById("search-results");var e=document.getElementById("pagination-controls-dict"),r=document.getElementById("button-addon2");if(o.innerHTML="",e&&(e.innerHTML=""),n.length<2)o.innerHTML='<p></p><p class="text-muted text-center">请输入至少2个字符</p><p></p>',n||showRandomStory(),r.disabled=!0;else{r.disabled=!1;let t=allIdioms.filter(e=>e.idiom?.includes(n)||e.definition?.includes(n));if(t.length){e=Math.ceil(t.length/3),r=e=>{o.innerHTML="",t.slice(3*(e-1),3*e).forEach(e=>{renderCard(o,highlightText(e.idiom,n),e.pinyin,buildCardContent({...e,definition:highlightText(e.definition,n)}))})},e=new Paginator("pagination-controls-dict",e,r);r(1),e.render(1)}else o.innerHTML='<p></p><p class="text-muted text-center">未找到相关成语</p><p></p>'}}function showIgcseIdioms(e=1){let t=document.getElementById("igcse-idioms");var n,o,r="pagination-controls-igcse",a=(t.innerHTML="",document.getElementById(r).innerHTML="",Object.entries(igcseData||{}).sort((e,t)=>t[0].localeCompare(e[0],"en",{numeric:!0}))),s=[];for([n,o]of a)for(let[t,e]of Object.entries(o)){var i=allIdioms.find(e=>e.idiom===t);i&&s.push({...i,exampleSentence:`${e} (${n})`})}s.length?(a=Math.ceil(s.length/3),e=Math.max(1,Math.min(e,a)),s.slice(3*(e-1),3*e).forEach(e=>{renderCard(t,e.idiom,e.pinyin,buildCardContent(e))}),new Paginator(r,a,e=>showIgcseIdioms(e)).render(e)):t.innerHTML="<p>暂无真题成语数据。</p>"}let currentQuestion=null,currentScore=0,bestScore=parseInt(localStorage.getItem("idiomGameBestScore"))||0;function nextQuestion(){var e=allIdioms[Math.floor(Math.random()*allIdioms.length)];let t=[e.idiom];for(;t.length<3;){var n=allIdioms[Math.floor(Math.random()*allIdioms.length)].idiom;t.includes(n)||t.push(n)}t=shuffle(t),currentQuestion={definition:e.definition,correctIndex:t.indexOf(e.idiom)},document.getElementById("question").innerHTML=`<strong style="border-bottom:#333 1px dashed">“${e.definition}” 对应的成语是？</strong>`,document.getElementById("options").innerHTML=t.map((t,e)=>{var n=allIdioms.find(e=>e.idiom===t);return`
      <div class="col">
        <button class="btn btn-outline-dark option card h-100" onclick="checkAnswer(${e})">
          <span class="card-body d-flex flex-column text-center card-chinese" style="justify-content:center; line-height:1.2">
            <span class="card-title mb-0">${t}<br /><small class="text-muted">${n?.pinyin||""}</small></span>
          </span>
        </button>
      </div>`}).join("")}function checkAnswer(e){var t,n,o;currentQuestion&&(t=document.getElementById("check-toast"),n=document.getElementById("toast-body"),o=bootstrap.Toast.getInstance(t)||new bootstrap.Toast(t),e===currentQuestion.correctIndex?(currentScore+=10,(document.getElementById("current-score").textContent=currentScore)>bestScore&&(bestScore=currentScore,document.getElementById("best-score").textContent=bestScore,localStorage.setItem("idiomGameBestScore",bestScore)),t.classList.replace("bg-danger","bg-success"),n.innerHTML="正确！+10 分",setTimeout(nextQuestion,300)):(t.classList.replace("bg-success","bg-danger"),n.innerHTML="错误。"),o.show())}function restartGame(){currentScore=0,document.getElementById("current-score").textContent=currentScore,nextQuestion()}function setupTabListeners(){document.querySelector('#myTabs a[href="#game"]').addEventListener("shown.bs.tab",()=>nextQuestion()),["#home","#dictionary"].forEach(e=>{document.querySelector(`#myTabs a[href="${e}"]`)?.addEventListener("shown.bs.tab",()=>{"#game"!==document.querySelector("#myTabs .nav-link.active")?.getAttribute("href")&&showRandomStory()})})}document.addEventListener("DOMContentLoaded",()=>{loadIgcseData(),loadAllIdioms(),document.getElementById("search-input").addEventListener("input",debounce(searchIdiom,100)),document.getElementById("button-addon2").disabled=!0,document.getElementById("best-score").textContent=bestScore});