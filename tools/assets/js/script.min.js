let appContainer=document.getElementById("app"),$=(appContainer.classList.add("loading-state"),e=>document.getElementById(e));function shuffle(e){var t=[...e];for(let e=t.length-1;0<e;e--){var n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}return t}function escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function highlightText(e,t){return t?e.replace(new RegExp(`(${escapeRegExp(t)})`,"gi"),"<mark>$1</mark>"):e}function debounce(t,n){let a;return(...e)=>{clearTimeout(a),a=setTimeout(()=>t.apply(this,e),n)}}function renderMessage(e,t,n="muted"){e.innerHTML=`<p></p><p class="text-${n} text-center">${t}</p><p></p>`}class Paginator{constructor(e,t,n,a=5){this.container=$(e),this.totalPages=t,this.onPageChange=n,this.maxButtons=a,this.currentPage=1}render(e=1){if(this.currentPage=e,this.container){var r,{totalPages:e,maxButtons:i,currentPage:o}=this;let t="";1<o&&(t+=`<li class="page-item"><a class="page-link" data-page="${o-1}" href="#">上一页</a></li>`);let n,a;e<=i?[n,a]=[1,e]:(r=Math.floor(i/2),[n,a]=o<=r?[1,i]:e<=o+r?[e-i+1,e]:[o-r,o+r]);for(let e=n;e<=a;e++){var s=e===o?"active":"";t+=`<li class="page-item ${s}"><a class="page-link" data-page="${e}" href="#">${e}</a></li>`}o<e&&(t+=`<li class="page-item"><a class="page-link" data-page="${o+1}" href="#">下一页</a></li>`),this.container.innerHTML=t,this.bindEvents()}}bindEvents(){this.container.onclick=e=>{var t=e.target.closest("a[data-page]");t&&(e.preventDefault(),e=parseInt(t.dataset.page,10))&&e!==this.currentPage&&(this.render(e),this.onPageChange(e))}}}let igcseData=null,allIdioms=[];async function loadIgcseData(){try{var e=await fetch("./dictionaries/idioms_cam_masked.min.json");if(!e.ok)throw new Error("HTTP "+e.status);igcseData=await e.json(),console.log("IGCSE 数据加载成功")}catch(e){console.error("加载 IGCSE 数据失败:",e),alert("无法加载数据，请稍后重试。")}}async function loadAllIdioms(){try{var e=await fetch("./dictionaries/idioms.min.json");allIdioms=await e.json(),appContainer.classList.remove("loading-state"),showHome(),showIgcseIdioms(),showRandomStory(),setupTabListeners()}catch(e){console.error("数据加载失败:",e),appContainer.classList.remove("loading-state"),renderMessage($("random-idioms"),"加载失败","danger")}}function renderCard(e,t,n,a){e.insertAdjacentHTML("beforeend",`
    <div class="col">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex flex-column card-chinese">
          <h5 class="card-title mb-4">${t}<br><small class="text-muted">${n}</small></h5>
          <p class="card-text mt-auto" style="padding-left:2.75rem">${a}</p>
        </div>
      </div>
    </div>`)}function buildCardContent(e){var t=(e,t)=>t?`<strong style="margin-left:-2.75rem">${e}</strong> `+t:"";return[t("释义",e.definition),t("用法",e.usage),t("出处",e.source?.text||(e.source?.book?`（${e.source.book}）`:"")),t("例句",e.example?.text||(e.example?.book?`（${e.example.book}）`:"")),t("官方",e.exampleSentence),e.similar?.length?t("近义",e.similar.join("、")):"",e.opposite?.length?t("反义",e.opposite.join("、")):""].filter(Boolean).join("<br />")}function showHome(){let t=$("random-idioms");allIdioms.length&&(t.innerHTML="",shuffle(allIdioms).slice(0,3).forEach(e=>renderCard(t,e.idiom,e.pinyin,buildCardContent(e))))}function showRandomStory(){let t=$("search-results");t.innerHTML="";var e=allIdioms.filter(e=>e.story?.length);if(!e.length)return renderMessage(t,"暂无成语故事");shuffle(e).slice(0,3).forEach(e=>renderCard(t,e.idiom,e.pinyin,'<strong style="margin-left:-2.75rem">故事</strong> '+e.story.join("<br /><br />")))}function searchIdiom(){let n=$("search-input").value.trim(),a=$("search-results");var r=$("pagination-controls-dict"),i=$("button-addon2");if(a.innerHTML="",r&&(r.innerHTML=""),n.length<2)renderMessage(a,"请输入至少2个字符"),n||showRandomStory(),i.disabled=!0;else{i.disabled=!1;let t=allIdioms.filter(e=>e.idiom?.includes(n)||e.definition?.includes(n));if(!t.length)return renderMessage(a,"未找到相关成语");let e=Math.ceil(t.length/3);r=e=>{a.innerHTML="",t.slice(3*(e-1),3*e).forEach(e=>{renderCard(a,highlightText(e.idiom,n),e.pinyin,buildCardContent({...e,definition:highlightText(e.definition,n)}))})};new Paginator("pagination-controls-dict",e,r).render(1),r(1)}}function showIgcseIdioms(e=1){let t=$("igcse-idioms");var n,a,r="pagination-controls-igcse",i=(t.innerHTML="",$(r).innerHTML="",Object.entries(igcseData||{}).sort((e,t)=>t[0].localeCompare(e[0],"en",{numeric:!0})));let o=[];for([n,a]of i)for(let[t,e]of Object.entries(a)){var s=allIdioms.find(e=>e.idiom===t);s&&o.push({...s,exampleSentence:`${e} (${n})`})}if(!o.length)return t.innerHTML="<p>暂无真题成语数据。</p>";let l=Math.ceil(o.length/3);i=e=>{t.innerHTML="",o.slice(3*(e-1),3*e).forEach(e=>renderCard(t,e.idiom,e.pinyin,buildCardContent(e)))};new Paginator(r,l,i).render(e),i(e)}let currentQuestion=null,currentScore=0,bestScore=parseInt(localStorage.getItem("idiomGameBestScore"))||0;function nextQuestion(){var e=allIdioms[Math.floor(Math.random()*allIdioms.length)];let t=[e.idiom];for(;t.length<3;){var n=allIdioms[Math.floor(Math.random()*allIdioms.length)].idiom;t.includes(n)||t.push(n)}t=shuffle(t),currentQuestion={definition:e.definition,correctIndex:t.indexOf(e.idiom)},$("question").innerHTML=`<strong style="border-bottom:#333 1px dashed">“${e.definition}” 对应的成语是？</strong>`,$("options").innerHTML=t.map((t,e)=>{var n=allIdioms.find(e=>e.idiom===t);return`
      <div class="col">
        <button class="btn btn-outline-dark option card h-100" onclick="checkAnswer(${e})">
          <span class="card-body d-flex flex-column text-center card-chinese" style="justify-content:center; line-height:1.2">
            <span class="card-title mb-0">${t}<br /><small class="text-muted">${n?.pinyin||""}</small></span>
          </span>
        </button>
      </div>`}).join("")}function checkAnswer(e){var t,n,a;currentQuestion&&(t=$("check-toast"),n=$("toast-body"),a=bootstrap.Toast.getInstance(t)||new bootstrap.Toast(t),e===currentQuestion.correctIndex?(currentScore+=10,($("current-score").textContent=currentScore)>bestScore&&(bestScore=currentScore,$("best-score").textContent=bestScore,localStorage.setItem("idiomGameBestScore",bestScore)),t.classList.replace("bg-danger","bg-success"),n.innerHTML="正确！+10 分",setTimeout(nextQuestion,300)):(t.classList.replace("bg-success","bg-danger"),n.innerHTML="错误。"),a.show())}function restartGame(){currentScore=0,$("current-score").textContent=currentScore,nextQuestion()}function setupTabListeners(){document.querySelector('#myTabs a[href="#game"]').addEventListener("shown.bs.tab",nextQuestion),["#home","#dictionary"].forEach(e=>{document.querySelector(`#myTabs a[href="${e}"]`)?.addEventListener("shown.bs.tab",()=>{"#game"!==document.querySelector("#myTabs .nav-link.active")?.getAttribute("href")&&showRandomStory()})})}document.addEventListener("DOMContentLoaded",()=>{loadIgcseData(),loadAllIdioms(),$("search-input").addEventListener("input",debounce(searchIdiom,100)),$("button-addon2").disabled=!0,$("best-score").textContent=bestScore});