<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cambridge IGCSE 中文成语词典</title>

  <!-- Bootstrap 5 CDN -->
  <link href="./assets/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="./assets/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">

  <style>
  /* 基础重置 */
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
    background-color:#fafafa;
    color: #333;
    line-height: 1.6;
  }

.card{ border:none }
.card-chinese{
    width:100%;
    margin:0 auto;
    padding:1rem;
    background-color:#d9f3ea;
    border-width:18px 18px;
    border-image:url(./assets/images/corner.png) 66 66 stretch;
    border-style:solid;
}
.card-chinese p{ text-align:justify; color:#666; font-size:.875rem}
.card .card-chinese{ padding:0;background-color:#fff}

  /* 主色调：柔和蓝色 */
  :root {
    --primary-color: #244f3d; /* 柔和蓝色 */
    --secondary-color: #75d1ae; /* 浅蓝色背景 */
    --card-bg: #ffffff;
    --text-muted: #666;
    --border-color: #ddd;
    --highlight-color: #ffc107;
  }

  h1, h2, h3, h4, h5, h6 {
    color: var(--primary-color);
    margin-bottom: 1rem;
  }

  .nav-tabs .nav-link {
    color: var(--primary-color);
    font-weight: 500;
    border: 1px solid var(--border-color);
    border-bottom-color:var(--primary-color);
  }

  .nav-tabs .nav-link.active {
    background-color: var(--secondary-color);
    color: var(--primary-color);
    border-color: var(--primary-color) var(--primary-color) var(--secondary-color);
  }

  .nav-tabs .nav-link:focus,
  .nav-tabs .nav-link:hover{
    border-bottom-color: var(--primary-color);
  }

  .nav-tabs .nav-link.active:focus,
  .nav-tabs .nav-link.active:hover{
    border-bottom-color: var(--secondary-color);
  }

  .justify-content-center{
    border-bottom-color: var(--primary-color);
  }

  .card {
    background-color: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    transition: box-shadow 0.3s ease;
  }

  .card:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .card-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .card-text {
    font-size: 0.95rem;
    color: var(--text-muted);
  }

  .btn-primary {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
    font-weight: 500;
    border-radius: 6px;
    padding: 0.4rem 1rem;
  }

  .btn-primary:hover {
    background-color: #3a75c0;
    border-color: #3a75c0;
  }

  .form-control {
    border-radius: 6px;
    border: 1px solid #ccc;
  }

  .form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
  }

  /* 高亮样式 */
  mark {
    background-color: var(--highlight-color);
    padding: 0 2px;
    font-weight: bold;
    color: #333;
  }

  /* 游戏选项按钮 */
  .option {
    border-radius: 6px;
    border: 1px solid #ccc;
    width: 100%;
    display: inline-block;

    margin:0;
    padding:0;
  border-radius: 6px;
  border: 1px solid #ccc;
/*  width: calc(40% - 1rem); */
  min-height: 3.5rem; /* 固定最小高度 */
  display: inline-flex;
  align-items: center;
  justify-content: flex-start;
  white-space: normal;
  word-wrap: break-word;
  text-align: left;
  }

  .option:hover {
    background-color: #f0f0f0;
    border-color: #aaa;
    color: #000;
  }
#check-toast {
  min-width: 240px;
  max-width: 320px;
  border: none;
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.18);
  /* 避免被其他元素遮挡 */
  pointer-events: auto;
}

#toast-body {
  padding: 1rem;
  font-size: 1.05rem;
  line-height: 1.5;
  font-weight: 500;
}

#current-score, #best-score {
  font-size: 1.2rem;
  font-weight: bold;
}

.text-primary { color: #007bff; }
.text-danger { color: #dc3545; }

/* 分页按钮样式 */
#pagination button {
    margin: 5px;
    padding: 10px;
    cursor: pointer;
}
#pagination button.active {
    background-color: lightblue;
}

/* 骨架屏容器 */

/* 骨架元素通用样式 */
.skeleton-title,
.skeleton-pinyin,
.skeleton-definition {
  background: linear-gradient(90deg, #e5e5e5 25%, #e0e0e0 50%, #e5e5e5 75%);
  background-size: 200% 100%;
  animation: skeleton-loading 1.5s infinite linear;
  border-radius: 4px;
}

.skeleton-title {
  width: 80px;
  height: 32px;
}

.skeleton-pinyin {
  width: 120px;
  height: 16px;
}

.skeleton-definition {
  width: 100%;
  height: 16px;
  max-width: 200px;
}

/* 动画：模拟加载光扫过的效果 */
@keyframes skeleton-loading {
  0% {
    background-position: 200% 0;
  }
  100% {
    background-position: -200% 0;
  }
}

/* 全局加载状态：禁用所有点击 */
.loading-state {
  pointer-events: none;
  opacity: 0.75;
  transition: opacity 0.2s ease;
}

/* 可选：鼠标样式 */
.loading-state * {
  cursor: not-allowed !important;
}

/* 响应式优化 */
@media (max-width: 768px) {
  .card-title {
    font-size: 1rem;
  }

  .card-text {
    font-size: 0.9rem;
  }
}
</style>
</head>
<body>

  <div id="app" class="container-lg py-4">
    <h1 class="text-center mb-5 mt-5">Cambridge IGCSE<br />中文成语词典</h1>

    <ul class="nav nav-tabs justify-content-center mb-4" id="myTabs">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#home">首页</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#dictionary">成语词典</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#igcse">真题成语</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#game">成语挑战</a></li>
    </ul>

    <div class="tab-content" style="min-height: 400px;">

      <!-- 首页 -->
      <div class="tab-pane fade show active" id="home">

        <div class="card-chinese">
          <h4 class="text-center mb-2">今日成语</h4>
          <p class="mb-0">中国的成语承载着深厚的文化底蕴，历经千百年沉淀，在跨文化交流中展现出强大的表达力和传意功能。在中文走向国际化的今天，成语是不可或缺的文化桥梁。作为一场国际化的中文考试，剑桥IGCSE中文第一语言（0509）的考试大纲要求我们掌握“恰当使用词汇”和“清晰有效传达信息”的能力，而成语正是实现这一目标的有力工具。让我们从今天开始，每天积累，让成语为我们的表达增光添彩！</p>
        </div>

        <div id="random-idioms" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3 mt-3">
          <!-- Skeleton Screen -->
          <div class="col">
            <div class="card h-100">
              <div class="card-body card-chinese">
                <div class="skeleton-title"></div>
                <div class="skeleton-pinyin mt-2"></div>
                <div class="skeleton-definition mt-3"></div>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card h-100">
              <div class="card-body card-chinese">
                <div class="skeleton-title"></div>
                <div class="skeleton-pinyin mt-2"></div>
                <div class="skeleton-definition mt-3"></div>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card h-100">
              <div class="card-body card-chinese">
                <div class="skeleton-title"></div>
                <div class="skeleton-pinyin mt-2"></div>
                <div class="skeleton-definition mt-3"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 成语词典 -->
      <div class="tab-pane fade" id="dictionary">
        <div class="card-chinese">
          <h4 class="text-center mb-4">查成语</h4>
          <div class="d-flex justify-content-center mb-3">
            <form class="input-group input-group-lg" style="max-width:600px" onsubmit="return false;">
              <input id="search-input" type="text" class="form-control" placeholder="输入成语搜索..." aria-label="请输入要搜索的成语，至少2个字符" aria-describedby="button-addon2" minlength="2">
              <button class="btn btn-outline-dark" type="submit" id="button-addon2" onclick="searchIdiom()" disabled>搜索</button>
            </form>
          </div>
        </div>
        <div id="search-results" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3 mt-3"></div>
        <nav aria-label="成语词典分页" class="mt-5">
          <ul class="pagination justify-content-center" id="pagination-controls-dict"></ul>
        </nav>
      </div>

      <!-- IGCSE真题 -->
      <div class="tab-pane fade" id="igcse">
        <div class="card-chinese">
          <h4 class="text-center mb-2">教材和真题中的成语</h4>
          <p class="mb-0">根据对剑桥IGCSE中文第一语言（0509）官方教材及历年真题（截至2025年）的统计，共出现207条成语，其中仅5条反复出现，绝大多数成语仅出现一次。这说明课程鼓励我们广泛积累，不断拓展成语词汇量。因此，我们不仅要掌握成语的字面含义，更要理解其在现代语境中的实际用法——了解人们通常在什么场合、表达何种情感时使用它。只有这样，我们才能真正领悟成语背后的深层文化意涵和语用功能，继而在阅读中准确把握文意，在写作中自然、恰当地运用成语，做到得心应手，游刃有余。</p>
        </div>

        <div id="igcse-idioms" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3 mt-3"></div>
        <nav aria-label="真题成语分页" class="mt-5">
          <ul class="pagination justify-content-center" id="pagination-controls-igcse"></ul>
        </nav>
        <div></div>
      </div>

      <!-- 成语游戏 -->
      <div class="tab-pane fade" id="game">
        <div class="card-chinese">
          <h4 class="text-center mb-2">50000条成语随机挑战</h4>
          <div style="text-align:center;">
            <span class="fs-5">当前得分：</span>
            <strong id="current-score" class="text-primary fs-4">0</strong>
            <span class="mx-3">|</span>
            <span class="fs-5">最高分：</span>
            <strong id="best-score" class="text-danger fs-4">0</strong>
          </div>
        </div>

        <!-- 游戏主体 -->
        <div id="game-container" class="text-center">
          <p id="question" class="lead mt-5"></p>
          <div id="options" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3 mt-3"></div>
          <p class="mt-5">
            <button class="btn btn-outline-dark" onclick="nextQuestion()">下一题</button>
            <button class="btn btn-outline-secondary" onclick="restartGame()">重新开始</button>
          </p>
        </div>
      </div>
    </div>
    <center class="card-text mt-5 ml-3 mr-3 fs-6" style="font-size:.875rem">Copyright &copy;2025 翟老师（Benjamin Z.）<br />数据来源：Mapull Chinese-dictionary & 剑桥真题</center>

  </div>
</div>

<!-- 居中 Toast 容器 -->
<div aria-live="polite" aria-atomic="true" class="position-fixed top-0 start-50 translate-middle-x" style="z-index: 1050;">
  <div id="check-toast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="2000">
    <div id="toast-body" class="d-flex align-items-center justify-content-center text-center"></div>
  </div>
</div>

<!-- Bootstrap JS Bundle with Popper -->
<script src="./assets/bootstrap/js/bootstrap.bundle.min.js"></script>

<script>

// 获取根容器
const appContainer = document.getElementById('app');

// 初始化：进入加载状态
appContainer.classList.add('loading-state');

// 通用分页组件（适配 <ul> 作为容器）
class Paginator {
  /**
   * @param {string} containerId - <ul> 的 ID，例如 'pagination-controls-dict'
   * @param {number} totalPages
   * @param {function} onPageChange
   * @param {number} maxButtons
   */
  constructor(containerId, totalPages, onPageChange, maxButtons = 5) {
    this.containerId = containerId;
    this.totalPages = totalPages;
    this.onPageChange = onPageChange;
    this.maxButtons = maxButtons;
    this.currentPage = 1;
  }

  // 渲染分页按钮到指定的 <ul>
  render(page = 1) {
    this.currentPage = page;
    const container = document.getElementById(this.containerId);
    if (!container) return;

    let html = '';

    // 上一页
    if (this.currentPage > 1) {
      html += `<li class="page-item"><a class="page-link" data-page="${this.currentPage - 1}" href="###">上一页</a></li>`;
    }

    // 计算页码范围
    let startPage, endPage;
    const { totalPages, maxButtons, currentPage } = this;

    if (totalPages <= maxButtons) {
      startPage = 1;
      endPage = totalPages;
    } else {
      const half = Math.floor(maxButtons / 2);
      if (currentPage <= half) {
        startPage = 1;
        endPage = maxButtons;
      } else if (currentPage + half >= totalPages) {
        startPage = totalPages - maxButtons + 1;
        endPage = totalPages;
      } else {
        startPage = currentPage - half;
        endPage = currentPage + half;
      }
    }

    // 页码按钮
    for (let i = startPage; i <= endPage; i++) {
      const active = i === this.currentPage ? 'active' : '';
      html += `<li class="page-item ${active}"><a class="page-link" data-page="${i}" href="###">${i}</a></li>`;
    }

    // 下一页
    if (this.currentPage < this.totalPages) {
      html += `<li class="page-item"><a class="page-link" data-page="${this.currentPage + 1}" href="###">下一页</a></li>`;
    }

    container.innerHTML = html;

    // ✅ 事件绑定（使用事件委托，绑定到 <ul> 自身）
    this.bindEvents(container);
  }

  // 绑定点击事件（安全绑定，防止重复）
  bindEvents(container) {
    // 移除旧事件监听器
    const cloned = container.cloneNode(true);
    container.replaceWith(cloned);

    // 添加新监听器
    cloned.addEventListener('click', (e) => {
      e.preventDefault();
      if (e.target.tagName === 'A') {
        const page = parseInt(e.target.dataset.page);
        if (!isNaN(page) && page >= 1 && page <= this.totalPages && page !== this.currentPage) {
          this.render(page); // 更新 UI
          this.onPageChange(page); // 回调业务逻辑
        }
      }
    });
  }

  // 外部跳转接口
  goTo(page) {
    if (page >= 1 && page <= this.totalPages && page !== this.currentPage) {
      this.render(page);
      this.onPageChange(page);
    }
  }
}

// 声明igcse成语
let igcseData = null;
async function loadIgcseData() {
  try {
      // 发起网络请求，获取 JSON 文件
      const response = await fetch('./dictionaries/idioms_cam.min.json');
      
      // 检查请求是否成功
      if (!response.ok) {
          throw new Error(`HTTP 错误！状态码: ${response.status}`);
      }
      
      // 将响应体解析为 JSON
      igcseData = await response.json();
      
      // ✅ 数据加载成功，现在可以使用 igcseData 了
      console.log("数据加载成功:", igcseData);
      
      // 在这里调用其他依赖 igcseData 的函数
      // initializeApp(); 
      // displayData();
      
  } catch (error) {
      console.error("加载数据失败:", error);
      // 可以在这里显示错误提示给用户
      alert("无法加载数据，请稍后重试。");
  }
}

// 页面加载完成后执行
document.addEventListener('DOMContentLoaded', () => {
    loadIgcseData();
});

// 全部成语
let allIdioms = [];

// 加载 JSON 数据
fetch('./dictionaries/idioms.min.json')
  .then(res => res.json())
  .then(data => {
    allIdioms = data;

    // 数据加载成功：移除加载状态
    appContainer.classList.remove('loading-state');

    // 渲染页面
    showHome();
    showIgcseIdioms();

    // 监听 tab 切换事件，自动加载游戏第一题
    const tabEl = document.querySelector('#myTabs a[href="#game"]');
    tabEl.addEventListener('shown.bs.tab', () => {
      nextQuestion();
    });
  })
  .catch(err => {
    console.error('数据加载失败:', err);
    // 即使失败，也应恢复交互（否则页面完全不可用）
    appContainer.classList.remove('loading-state');
    const container = document.getElementById('random-idioms');
    container.innerHTML = '<p></p><p class="text-danger">加载失败</p><p></p>';
  });

// 显示首页随机成语
function showHome() {
  const container = document.getElementById('random-idioms');

  // 如果数据未加载，确保骨架屏已存在（通常 HTML 已写好）
  if (!allIdioms || allIdioms.length === 0) {
    // 骨架屏已在 HTML 中，无需操作
    return;
  }

  // ✅ 数据已加载：清空容器，渲染真实内容
  container.innerHTML = ''; // 🔥 自动移除骨架屏

  // 数据已加载，生成随机成语
  const randomIds = shuffle(allIdioms).slice(0, 3);
  container.innerHTML = '';
  randomIds.forEach(idiom => {
    renderCard(container, idiom.idiom, idiom.pinyin, idiom.definition);
  });
}

// 渲染卡片函数
function renderCard(container, title, pinyin, content) {
  const col = document.createElement('div');
  col.className = 'col';
  col.innerHTML = `
    <div class="card shadow-sm h-100">
      <div class="card-body d-flex flex-column card-chinese">
        <h5 class="card-title mb-4">${title}<br><small class="text-muted" style="font-family:Helvetica, Arial, sans-serif">${pinyin}</small></h5>
        <p class="card-text mt-auto">${content}</p>
      </div>
    </div>
  `;
  container.appendChild(col);
}

// 高亮关键词函数
function highlightText(text, keyword) {
  if (!keyword || !text) return text;

  const escapeRegExp = (s) => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const pattern = new RegExp(`(${escapeRegExp(keyword)})`, 'gi');
  return text.replace(pattern, '<mark>$1</mark>');
}

// 搜索成语
// 监听搜索框至少输入两个字符
const searchInput = document.getElementById('search-input');
const searchBtn = document.getElementById('button-addon2');

// 监听输入框内容变化
searchInput.addEventListener('input', function () {
  const query = this.value.trim(); // 去除首尾空格

  // 如果输入字符数 >= 2，启用按钮；否则禁用
  if (query.length >= 2) {
    searchBtn.disabled = false;
  } else {
    searchBtn.disabled = true;
  }
});

// 可选：页面加载时确保按钮初始状态
searchBtn.disabled = true;

function searchIdiom() {
  const input = document.getElementById('search-input').value.trim();
  const resultsContainer = document.getElementById('search-results');
  const paginationContainerId = 'pagination-controls-dict'; // 对应 <ul> 的 ID

  // 清空内容
  resultsContainer.innerHTML = '';
  const paginationContainer = document.getElementById(paginationContainerId);
  if (paginationContainer) paginationContainer.innerHTML = '';

  // 输入为空
  if (!input) {
    resultsContainer.innerHTML = '<p></p><p class="text-muted text-center">请输入关键词搜索成语。</p><p></p>';
    return;
  }

  // 过滤成语：匹配成语本身或释义
  const results = allIdioms.filter(idiom =>
    idiom.idiom && idiom.idiom.toLowerCase().includes(input.toLowerCase()) ||
    (idiom.definition && typeof idiom.definition === 'string' && 
     idiom.definition.toLowerCase().includes(input.toLowerCase()))
  );

  // 无结果
  if (results.length === 0) {
    resultsContainer.innerHTML = '<p></p><p class="text-muted text-center">未找到相关成语。</p><p></p>';
    return;
  }

  // ✅ 分页逻辑开始
  const itemsPerPage = 6;
  const totalPages = Math.ceil(results.length / itemsPerPage);

  // ✅ 定义渲染当前页内容的函数（可复用）
  const renderResultsPage = (page) => {
    const start = (page - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const paginatedResults = results.slice(start, end);

    resultsContainer.innerHTML = ''; // 清空当前显示

    paginatedResults.forEach(idiom => {
      const highlightedIdiom = highlightText(idiom.idiom, input);
      const highlightedDef = highlightText(idiom.definition, input);
      renderCard(resultsContainer, highlightedIdiom, idiom.pinyin, highlightedDef);
    });
  };

  // ✅ 创建分页器实例
  const paginator = new Paginator(paginationContainerId, totalPages, (page) => {
    renderResultsPage(page); // 用户点击页码时触发
  });

  // 🔥 关键修复：先手动渲染第一页内容，再渲染分页控件
  renderResultsPage(1);       // ✅ 立即显示第一页内容
  paginator.render(1);        // ✅ 渲染分页按钮（当前页为1）
}

// 显示 IGCSE 成语
// 全局变量用于存储当前页码
let currentPage = 1;
const pageSize = 6; // 每页显示的成语数量

function showIgcseIdioms() {
  const container = document.getElementById('igcse-idioms');
  container.innerHTML = ''; // 清空容器

  // 1. 获取所有条目并转换为数组
  const entries = Object.entries(igcseData);

  // 2. 按 exam（即文件名）倒序排序
  entries.sort((a, b) => {
    const examA = a[0];
    const examB = b[0];
    return examB.localeCompare(examA, 'en', { numeric: true, sensitivity: 'base' });
  });

  // 3. 收集所有条目
  let allItems = [];
  entries.forEach(([exam, idiomToExampleMap]) => {
    Object.entries(idiomToExampleMap).forEach(([idiomName, exampleSentence]) => {
      const item = allIdioms.find(i => i.idiom === idiomName);
      if (item) {
        allItems.push({
          idiom: item.idiom,
          pinyin: item.pinyin,
          definition: item.definition,
          exampleSentence: `${exampleSentence} (${exam})`
        });
      }
    });
  });

  // 4. 计算总页数
  const pageSize = 6; // 假设每页6条（与之前的逻辑一致）
  const totalPages = Math.ceil(allItems.length / pageSize);

  // 确保 currentPage 合法
  if (currentPage < 1) currentPage = 1;
  if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;

  // 获取当前页的数据
  const startIdx = (currentPage - 1) * pageSize;
  const endIdx = startIdx + pageSize;
  const currentItems = allItems.slice(startIdx, endIdx);

  // 渲染当前页的成语卡片
  currentItems.forEach(item => {
    renderCard(
      container,
      item.idiom,
      item.pinyin,
      `<strong>辞典释义：</strong>${item.definition}<br /><strong>官方例句：</strong>${item.exampleSentence}`
    );
  });

  // 使用 Paginator
  const paginator = new Paginator('pagination-controls-igcse', totalPages, (page) => {
    // 分页回调：更新 currentPage 并重新渲染
    currentPage = page;
    showIgcseIdioms(); // 重新调用自身，刷新内容和分页
  });

  // 渲染分页控件
  paginator.render(currentPage);
}

// 跳转到指定页码的函数
function goToPage(page) {
  // 重新计算总页数（基于当前数据）
  const totalItems = Object.entries(igcseData).reduce(
    (acc, [exam, map]) => acc + Object.keys(map).length,
    0
  );
  const totalPages = Math.ceil(totalItems / 6);

  // 安全检查
  if (Number.isInteger(page) && page >= 1 && page <= totalPages && page !== currentPage) {
    currentPage = page;
    showIgcseIdioms(); // 重新渲染页面
  }
}

// 初始化游戏
let currentQuestion = null;

function nextQuestion() {
  // 随机选择一个成语作为正确答案
  const randomIdiom = allIdioms[Math.floor(Math.random() * allIdioms.length)];
  
  // 正确选项是成语名
  let options = [randomIdiom.idiom];

  // 添加其他 2 个干扰项（其他成语的名字）
  while (options.length < 3) {
    const candidate = allIdioms[Math.floor(Math.random() * allIdioms.length)].idiom;
    if (!options.includes(candidate)) {
      options.push(candidate);
    }
  }

  // 打乱选项顺序
  options = shuffle(options);

  // 记录正确答案的新位置
  currentQuestion = {
    definition: randomIdiom.definition, // 当前释义
    correctIndex: options.indexOf(randomIdiom.idiom) // 成语在打乱后的位置
  };

  // 显示问题：根据释义猜成语
  document.getElementById('question').innerHTML = `<strong style="border-bottom:#333 1px dashed">“${randomIdiom.definition}” 对应的成语是？</strong>`;

  // 渲染选项按钮（显示成语名）
  document.getElementById('options').innerHTML = options.map((idiom, index) => {
    // 查找该成语的拼音（用于显示）
    const item = allIdioms.find(i => i.idiom === idiom);
    const pinyin = item ? item.pinyin : '未知拼音';

    return `
      <div class="col">
        <button class="btn btn-outline-dark option card h-100" onclick="checkAnswer(${index})">
          <span class="card-body d-flex flex-column text-center card-chinese" style="justify-content: center; line-height:1.2">
            <span class="card-title mb-0">${idiom}<br /><small class="text-muted">${pinyin}</small></span>
          </span>
        </button>
      </div>
    `;
  }).join('');

}

function checkAnswer(index) {
  if (!currentQuestion) return;
  const toastEl = document.getElementById('check-toast');
  const toastBody = document.getElementById('toast-body');
  const toast = bootstrap.Toast.getInstance(toastEl) || new bootstrap.Toast(toastEl);

  const isCorrect = index === currentQuestion.correctIndex;

  if (isCorrect) {
    // 答对：加 10 分
    currentScore += 10;
    document.getElementById('current-score').textContent = currentScore;

    // 更新最高分（如果需要）
    if (currentScore > bestScore) {
      bestScore = currentScore;
      document.getElementById('best-score').textContent = bestScore;
      localStorage.setItem('idiomGameBestScore', bestScore);
    }

    // 显示 Toast
    toastEl.classList.remove('bg-danger', 'text-white');
    toastEl.classList.add('bg-success', 'text-white');
    toastBody.innerHTML = '正确！+10 分';

    // 自动进入下一题
    setTimeout(() => {
      nextQuestion();
    }, 300);
  } else {
    // 答错：不加分
    toastEl.classList.remove('bg-success', 'text-white');
    toastEl.classList.add('bg-danger', 'text-white');
    toastBody.innerHTML = `错误。`;
  }

  // 显示 Toast
  toast.hide();
  toast.show();
}

// 辅助函数：洗牌
function shuffle(array) {
  return [...array].sort(() => Math.random() - 0.5);
}

// 计分变量
let currentScore = 0;
let bestScore = parseInt(localStorage.getItem('idiomGameBestScore')) || 0;

// 页面加载后显示最高分
document.addEventListener('DOMContentLoaded', () => {
  const bestScoreEl = document.getElementById('best-score');
  if (bestScoreEl) {
    bestScoreEl.textContent = bestScore;
  }
});
function restartGame() {
  currentScore = 0;
  document.getElementById('current-score').textContent = currentScore;
  nextQuestion();
}
</script>
</body>
</html>