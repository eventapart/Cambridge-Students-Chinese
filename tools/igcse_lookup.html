<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cambridge IGCSE 中文成语词典</title>

  <!-- Bootstrap 5 CDN -->
  <link href="./assets/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="./assets/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">

  <style>
  /* 基础重置 */
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
    background-color:#fafafa;
    color: #333;
    line-height: 1.6;
  }

  /* 主色调：柔和蓝色 */
  :root {
    --primary-color: #244f3d; /* 柔和蓝色 */
    --secondary-color: #75d1ae; /* 浅蓝色背景 */
    --card-bg: #ffffff;
    --text-muted: #666;
    --border-color: #ddd;
    --highlight-color: #ffc107;
  }

  h1, h2, h3, h4, h5, h6 {
    color: var(--primary-color);
    margin-bottom: 1rem;
  }

  .nav-tabs .nav-link {
    color: var(--primary-color);
    font-weight: 500;
    border: 1px solid var(--border-color);
  }

  .nav-tabs .nav-link.active {
    background-color: var(--secondary-color);
    color: var(--primary-color);
    border-color: var(--primary-color) var(--primary-color) var(--border-color);
  }

  .card {
    background-color: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    transition: box-shadow 0.3s ease;
  }

  .card:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .card-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .card-text {
    font-size: 0.95rem;
    color: var(--text-muted);
  }

  .btn-primary {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
    font-weight: 500;
    border-radius: 6px;
    padding: 0.4rem 1rem;
  }

  .btn-primary:hover {
    background-color: #3a75c0;
    border-color: #3a75c0;
  }

  .form-control {
    border-radius: 6px;
    border: 1px solid #ccc;
  }

  .form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
  }

  /* 高亮样式 */
  mark {
    background-color: var(--highlight-color);
    padding: 0 2px;
    font-weight: bold;
    color: #333;
  }

  /* 游戏选项按钮 */
  .option {
    border-radius: 6px;
    border: 1px solid #ccc;
    width: 100%;
    display: inline-block;

    margin:0;
    padding:0;
  border-radius: 6px;
  border: 1px solid #ccc;
/*  width: calc(40% - 1rem); */
  min-height: 3.5rem; /* 固定最小高度 */
  display: inline-flex;
  align-items: center;
  justify-content: flex-start;
  white-space: normal;
  word-wrap: break-word;
  text-align: left;
  }

  .option:hover {
    background-color: #f0f0f0;
    border-color: #aaa;
    color: #000;
  }
#check-toast {
  min-width: 240px;
  max-width: 320px;
  border: none;
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.18);
  /* 避免被其他元素遮挡 */
  pointer-events: auto;
}

#toast-body {
  padding: 1rem;
  font-size: 1.05rem;
  line-height: 1.5;
  font-weight: 500;
}

#current-score, #best-score {
  font-size: 1.2rem;
  font-weight: bold;
}

.text-primary { color: #007bff; }
.text-danger { color: #dc3545; }

/* 分页按钮样式 */
#pagination button {
    margin: 5px;
    padding: 10px;
    cursor: pointer;
}
#pagination button.active {
    background-color: lightblue;
}

/* 响应式优化 */
@media (max-width: 768px) {
  .card-title {
    font-size: 1rem;
  }

  .card-text {
    font-size: 0.9rem;
  }
}
</style>
</head>
<body>

  <div class="container-lg py-4">
    <h1 class="text-center mb-5 mt-5">Cambridge IGCSE<br />中文成语词典</h1>

    <ul class="nav nav-tabs justify-content-center mb-4" id="myTabs">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#home">首页</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#dictionary">成语词典</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#igcse">真题成语</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#game">成语挑战</a></li>
    </ul>

    <div class="tab-content" style="min-height: 400px;">

      <!-- 首页 -->
      <div class="tab-pane fade show active" id="home">
        <h4 class="text-center mb-4">今日成语</h4>
        <div id="random-idioms" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 g-3">
          <div></div><div class="text-center"><div class="spinner-border" role="status"><span class="sr-only"></span></div></div><div></div>
        </div>
      </div>

      <!-- 成语词典 -->
      <div class="tab-pane fade" id="dictionary">
        <h4 class="text-center mb-4">查成语</h4>
        <div class="d-flex justify-content-center mb-3">
          <div class="input-group input-group-lg mb-3">
            <input id="search-input" type="text" class="form-control" placeholder="输入成语搜索..." aria-label="输入成语搜索..." aria-describedby="button-addon2">
            <button class="btn btn-outline-dark" type="button" id="button-addon2" onclick="searchIdiom()">搜索</button>
          </div>
        </div>
        <div id="search-results" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4"></div>
      </div>

      <!-- IGCSE真题 -->
      <div class="tab-pane fade" id="igcse">
        <h4 class="text-center mb-4">官方教材和历史真题中的成语 2016-2025</h4>
        <div id="igcse-idioms" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4"></div>
        <nav aria-label="Page navigation example mt-5" class="mt-5" id="pagination"></nav>
        <div></div>
      </div>

      <!-- 成语游戏 -->
      <div class="tab-pane fade" id="game">
        <h4 class="text-center mb-4">50000条成语随机挑战</h4>

          <!-- 计分栏 -->
          <div class="card text-center text-dark bg-light" style="max-width:600px; margin:0 auto">
            <div class="card-header">
              记分牌
            </div>
            <div class="card-body">
              <h5 class="card-title">
                <span class="fs-5">当前得分：</span>
                <strong id="current-score" class="text-primary fs-4">0</strong>
                <span class="mx-3">|</span>
                <span class="fs-5">最高分：</span>
                <strong id="best-score" class="text-danger fs-4">0</strong>
              </h5>
            </div>
          </div>

          <!-- 游戏主体 -->
          <div id="game-container" class="text-center">
            <p id="question" class="lead mt-5 mb-5 ml-5 mr-5"></p>
            <div id="options" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4"></div>
            <p class="mt-5">
              <button class="btn btn-outline-dark" onclick="nextQuestion()">下一题</button>
              <button class="btn btn-outline-secondary" onclick="restartGame()">重新开始</button>
            </p>
          </div>
        </div>
      </div>

    </div>
    <p class="fs-6"><center class="card-text mt-5">Copyright &copy; 2025 Mr. Z-Benjamin<br />数据来源：码谱mapull's chinese-dictionary & IGCSE0509历年真题</center></p>
  </div>

<!-- 居中 Toast 容器 -->
<div aria-live="polite" aria-atomic="true" class="position-fixed top-0 start-50 translate-middle-x" style="z-index: 1050;">
  <div id="check-toast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="2000">
    <div id="toast-body" class="d-flex align-items-center justify-content-center text-center"></div>
  </div>
</div>

  <!-- Bootstrap JS Bundle with Popper -->
  <script src="./assets/bootstrap/js/bootstrap.bundle.min.js"></script>

  <script>

    // 声明igcse成语
    let igcseData = null;
    async function loadIgcseData() {
            try {
                // 发起网络请求，获取 JSON 文件
                const response = await fetch('./dictionaries/idioms_cam.min.json');
                
                // 检查请求是否成功
                if (!response.ok) {
                    throw new Error(`HTTP 错误！状态码: ${response.status}`);
                }
                
                // 将响应体解析为 JSON
                igcseData = await response.json();
                
                // ✅ 数据加载成功，现在可以使用 igcseData 了
                console.log("数据加载成功:", igcseData);
                
                // 在这里调用其他依赖 igcseData 的函数
                // initializeApp(); 
                // displayData();
                
            } catch (error) {
                console.error("加载数据失败:", error);
                // 可以在这里显示错误提示给用户
                alert("无法加载数据，请稍后重试。");
            }
        }

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', () => {
            loadIgcseData();
        });

    // 全部成语
    let allIdioms = [];

    // 加载 JSON 数据
    fetch('./dictionaries/idioms.min.json')
      .then(res => res.json())
      .then(data => {
        allIdioms = data;
        showHome();
        showIgcseIdioms();

        // 监听 tab 切换事件，自动加载游戏第一题
        const tabEl = document.querySelector('#myTabs a[href="#game"]');
        tabEl.addEventListener('shown.bs.tab', () => {
          nextQuestion();
        });
      })
      .catch(err => console.error('数据加载失败:', err));

    // 显示首页随机成语
    function showHome() {
      const container = document.getElementById('random-idioms');

      // 如果数据还没加载完，显示 loading
      if (!allIdioms || allIdioms.length === 0) {
        container.innerHTML = '<div></div><div class="text-center"><div class="spinner-border" role="status"><span class="sr-only"></span></div></div><div></div>';
        return;
      }

      // 数据已加载，生成随机成语
      const randomIds = shuffle(allIdioms).slice(0, 12);
      container.innerHTML = '';
      randomIds.forEach(idiom => {
        renderCard(container, idiom.idiom, idiom.pinyin, idiom.definition);
      });
    }

    // 渲染卡片函数
    function renderCard(container, title, pinyin, content) {
      const col = document.createElement('div');
      col.className = 'col';
      col.innerHTML = `
        <div class="card shadow-sm h-100">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title mb-4">${title}<br><small class="text-muted" style="font-family:Helvetica, Arial, sans-serif">${pinyin}</small></h5>
            <p class="card-text mt-auto">${content}</p>
          </div>
        </div>
      `;
      container.appendChild(col);
    }

    // 高亮关键词函数
    function highlightText(text, keyword) {
      if (!keyword || !text) return text;

      const escapeRegExp = (s) => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const pattern = new RegExp(`(${escapeRegExp(keyword)})`, 'gi');
      return text.replace(pattern, '<mark>$1</mark>');
    }

    // 搜索成语
    function searchIdiom() {
      const input = document.getElementById('search-input').value.trim();
      const results = allIdioms.filter(idiom =>
        // 确保 idiom.definition 存在且为字符串，然后再调用 toLowerCase 和 includes
        idiom.idiom && idiom.idiom.toLowerCase().includes(input.toLowerCase()) ||
        (idiom.definition && typeof idiom.definition === 'string' && idiom.definition.toLowerCase().includes(input.toLowerCase()))
      );
      const container = document.getElementById('search-results');
      container.innerHTML = '';

      if (results.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">未找到相关成语。</p>';
      } else {
        results.forEach(idiom => {
          const highlightedIdiom = highlightText(idiom.idiom, input);
          const highlightedDef = highlightText(idiom.definition, input);

          renderCard(container, highlightedIdiom, idiom.pinyin, highlightedDef);
        });
      }
    }

    // 显示 IGCSE 成语
    // 全局变量用于存储当前页码
    let currentPage = 1;
    const pageSize = 12; // 每页显示的成语数量

    function showIgcseIdioms() {
      const container = document.getElementById('igcse-idioms');
      container.innerHTML = ''; // 清空容器

      // 1. 获取所有条目并转换为数组
      const entries = Object.entries(igcseData);

      // 2. 按 exam（即文件名）倒序排序
      entries.sort((a, b) => {
        const examA = a[0];
        const examB = b[0];
        return examB.localeCompare(examA, 'en', { numeric: true, sensitivity: 'base' });
      });

      // 3. 计算总条目数
      let allItems = [];
      entries.forEach(([exam, idiomToExampleMap]) => {
        Object.entries(idiomToExampleMap).forEach(([idiomName, exampleSentence]) => {
          const item = allIdioms.find(i => i.idiom === idiomName);
          if (item) {
            allItems.push({
              idiom: item.idiom,
              pinyin: item.pinyin,
              definition: item.definition,
              exampleSentence: `${exampleSentence} (${exam})`
            });
          }
        });
      });

      // 4. 计算总页数
      const totalPages = Math.ceil(allItems.length / pageSize);

      // 获取当前页的成语数据
      const startIdx = (currentPage - 1) * pageSize;
      const endIdx = startIdx + pageSize;
      const currentItems = allItems.slice(startIdx, endIdx);

      // 渲染当前页的成语卡片
      currentItems.forEach(item => {
        renderCard(
          container,
          item.idiom,
          item.pinyin,
          `<strong>辞典释义：</strong>${item.definition}<br /><strong>官方例句：</strong>${item.exampleSentence}`
        );
      });

      // 渲染分页控件
      renderPagination(totalPages);
    }

    // 渲染分页控件（使用 Bootstrap，禁用按钮）
    function renderPagination(totalPages) {
      const paginationContainer = document.getElementById('pagination');
      
      // 清空并生成分页 HTML（不包含 onclick）
      let html = `
        <ul class="pagination justify-content-center" id="pagination-controls">
      `;

      // 上一页
      if (currentPage > 1) {
        html += `<li class="page-item"><a class="page-link" data-page="${currentPage - 1}" href="###">上一页</a></li>`;
      }

      // 页码按钮
      const maxButtons = 8;
      let startPage, endPage;

      if (totalPages <= maxButtons) {
        startPage = 1;
        endPage = totalPages;
      } else {
        const half = Math.floor(maxButtons / 2);
        if (currentPage <= half) {
          startPage = 1;
          endPage = maxButtons;
        } else if (currentPage + half >= totalPages) {
          startPage = totalPages - maxButtons + 1;
          endPage = totalPages;
        } else {
          startPage = currentPage - half;
          endPage = currentPage + half;
        }
      }

      for (let i = startPage; i <= endPage; i++) {
        const btnClass = i === currentPage ? 'active' : '';
        html += `<li class="page-item ${btnClass}"><a class="page-link" data-page="${i}" href="###">${i}</a></li>`;
      }

      // 下一页
      if (currentPage < totalPages) {
        html += `<li class="page-item"><a class="page-link" data-page="${currentPage + 1}" href="###">下一页</a></li>`;
      }

      html += `</ul>`;
      paginationContainer.innerHTML = html;

      // ✅ 使用事件委托绑定点击事件
      const controls = document.getElementById('pagination-controls');
      controls.addEventListener('click', function(e) {
        if (e.target.tagName === 'A') {
          const page = parseInt(e.target.dataset.page); // 从 data-page 获取目标页码
          if (!isNaN(page)) {
            goToPage(page); // 调用跳转函数
          }
        }
      });
    }

    // 生成页码按钮的 HTML 字符串
    function generatePageButtons(currentPage, totalPages) {
      let buttonsHTML = '';

      // 显示逻辑：最多显示 7 个页码按钮（可调整）
      const maxButtons = 7;
      let startPage, endPage;

      if (totalPages <= maxButtons) {
        // 总页数少，显示全部
        startPage = 1;
        endPage = totalPages;
      } else {
        // 总页数多，居中当前页
        const half = Math.floor(maxButtons / 2);
        if (currentPage <= half) {
          startPage = 1;
          endPage = maxButtons;
        } else if (currentPage + half >= totalPages) {
          startPage = totalPages - maxButtons + 1;
          endPage = totalPages;
        } else {
          startPage = currentPage - half;
          endPage = currentPage + half;
        }
      }

      for (let i = startPage; i <= endPage; i++) {
        buttonsHTML += `
          <li class="page-item ${i === currentPage ? '' : 'active'}"><a class="page-link" data-page="${currentPage + 1}" href="#" onclick="goToPage(${i})">${i}</a></li>
        `;
      }

      return buttonsHTML;
    }

    // 跳转到指定页码的函数
    function goToPage(page) {
      // 重新计算总页数（基于当前 igcseData 数据总量）
      const totalItems = Object.entries(igcseData).reduce(
        (acc, [exam, map]) => acc + Object.keys(map).length,
        0
      );
      const totalPages = Math.ceil(totalItems / 6);

      // ✅ 安全检查：page 必须是有效数字，且在范围内，且不是当前页
      if (Number.isInteger(page) && page >= 1 && page <= totalPages && page !== currentPage) {
        currentPage = page;
        showIgcseIdioms(); // 重新渲染成语列表
      }
      // 否则：无效点击，静默忽略
    }

    // 初始化游戏
    let currentQuestion = null;

    function nextQuestion() {
      // 随机选择一个成语作为正确答案
      const randomIdiom = allIdioms[Math.floor(Math.random() * allIdioms.length)];
      
      // 正确选项是成语名
      let options = [randomIdiom.idiom];

      // 添加其他 5 个干扰项（其他成语的名字）
      while (options.length < 6) {
        const candidate = allIdioms[Math.floor(Math.random() * allIdioms.length)].idiom;
        if (!options.includes(candidate)) {
          options.push(candidate);
        }
      }

      // 打乱选项顺序
      options = shuffle(options);

      // 记录正确答案的新位置
      currentQuestion = {
        definition: randomIdiom.definition, // 当前释义
        correctIndex: options.indexOf(randomIdiom.idiom) // 成语在打乱后的位置
      };

      // 显示问题：根据释义猜成语
      document.getElementById('question').innerHTML = `<strong>“${randomIdiom.definition}” 对应的成语是？</strong>`;

      // 渲染选项按钮（显示成语名）
      document.getElementById('options').innerHTML = options.map((idiom, index) => {
        // 查找该成语的拼音（用于显示）
        const item = allIdioms.find(i => i.idiom === idiom);
        const pinyin = item ? item.pinyin : '未知拼音';

        return `
          <div class="col">
            <button class="btn btn-outline-dark option card h-100" onclick="checkAnswer(${index})">
              <span class="card-body d-flex flex-column text-center" style="justify-content: center; line-height:1.2">
                <span class="card-title mb-0">${idiom}<br /><small class="text-muted">${pinyin}</small></span>
              </span>
            </button>
          </div>
        `;
      }).join('');

    }

    function checkAnswer(index) {
      if (!currentQuestion) return;
      const toastEl = document.getElementById('check-toast');
      const toastBody = document.getElementById('toast-body');
      const toast = bootstrap.Toast.getInstance(toastEl) || new bootstrap.Toast(toastEl);

      const isCorrect = index === currentQuestion.correctIndex;

      if (isCorrect) {
        // 答对：加 10 分
        currentScore += 10;
        document.getElementById('current-score').textContent = currentScore;

        // 更新最高分（如果需要）
        if (currentScore > bestScore) {
          bestScore = currentScore;
          document.getElementById('best-score').textContent = bestScore;
          localStorage.setItem('idiomGameBestScore', bestScore);
        }

        // 显示 Toast
        toastEl.classList.remove('bg-danger', 'text-white');
        toastEl.classList.add('bg-success', 'text-white');
        toastBody.innerHTML = '正确！+10 分';

        // 自动进入下一题
        setTimeout(() => {
          nextQuestion();
        }, 300);
      } else {
        // ❌ 答错：不加分
        const correctDef = allIdioms.find(i => i.idiom === currentQuestion.idiom).definition;
        toastEl.classList.remove('bg-success', 'text-white');
        toastEl.classList.add('bg-danger', 'text-white');
        toastBody.innerHTML = `错误。`;
      }

      // 显示 Toast
      toast.hide();
      toast.show();
    }

    // 辅助函数：洗牌
    function shuffle(array) {
      return [...array].sort(() => Math.random() - 0.5);
    }

    // 计分变量
    let currentScore = 0;
    let bestScore = parseInt(localStorage.getItem('idiomGameBestScore')) || 0;

    // 页面加载后显示最高分
    document.addEventListener('DOMContentLoaded', () => {
      const bestScoreEl = document.getElementById('best-score');
      if (bestScoreEl) {
        bestScoreEl.textContent = bestScore;
      }
    });
    function restartGame() {
      currentScore = 0;
      document.getElementById('current-score').textContent = currentScore;
      nextQuestion();
    }
  </script>
</body>
</html>